 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BudgetMaster – YNAB-Like Monitoring</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

   <style>
 /* === Enhanced Theme System === */
    :root {
      /* Classic Theme (Default) */
      --bg: #f7f9fb;
      --card-bg: #ffffff;
      --primary: #005ca9;
      --primary-hover: #004a8a;
      --secondary: #e8f2ff;
      --text: #2d3748;
      --text-light: #718096;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --radius: 6px;
      --header-bg: #ffffff;
      --header-text: #2d3748;
      --sidebar-bg: #ffffff;
      --sidebar-text: #4a5568;
      --sidebar-hover: #e8f2ff;
      --sidebar-active: #005ca9;
      --danger: #e53e3e;
      --danger-hover: #c53030;
      --ynab-blue: #005ca9;
      --ynab-dark-blue: #004a8a;
      --ynab-light-blue: #e8f2ff;
      --ynab-green: #38a169;
      --ynab-red: #e53e3e;
      --ynab-orange: #ed8936;
      --ynab-yellow: #d69e2e;
      --ynab-border: #e2e8f0;
      --ynab-light-gray: #f7fafc;
      --ynab-text: #2d3748;
      --ynab-text-light: #718096;
      --ynab-bg-secondary: #f7fafc;
      
      /* Theme identifier */
      --theme-name: "Classic";
    }

    /* Dark Theme */
    [data-theme="dark"] {
      --bg: #1a1a1a;
      --card-bg: #2d2d2d;
      --primary: #4a9eff;
      --primary-hover: #3a8eef;
      --secondary: #3a3a3a;
      --text: #ffffff;
      --text-light: #b0b0b0;
      --shadow: 0 2px 8px rgba(0,0,0,0.3);
      --header-bg: #2d2d2d;
      --header-text: #ffffff;
      --sidebar-bg: #2d2d2d;
      --sidebar-text: #b0b0b0;
      --sidebar-hover: #3a3a3a;
      --sidebar-active: #4a9eff;
      --danger: #ff6b6b;
      --danger-hover: #ff5252;
      --ynab-blue: #4a9eff;
      --ynab-dark-blue: #3a8eef;
      --ynab-light-blue: #3a3a3a;
      --ynab-green: #51cf66;
      --ynab-red: #ff6b6b;
      --ynab-orange: #ffa726;
      --ynab-yellow: #ffeb3b;
      --ynab-border: #4a4a4a;
      --ynab-light-gray: #3a3a3a;
      --ynab-text: #ffffff;
      --ynab-text-light: #b0b0b0;
      --ynab-bg-secondary: #3a3a3a;
      --theme-name: "Dark";
    }

    /* Koopa Beach Theme */
    [data-theme="koopa-beach"] {
      --bg: linear-gradient(135deg, #fef7cd 0%, #e8f5e8 100%);
      --card-bg: rgba(255, 255, 255, 0.9);
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary: #dbeafe;
      --text: #1e293b;
      --text-light: #64748b;
      --shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
      --header-bg: rgba(255, 255, 255, 0.95);
      --header-text: #1e293b;
      --sidebar-bg: rgba(255, 255, 255, 0.95);
      --sidebar-text: #64748b;
      --sidebar-hover: #dbeafe;
      --sidebar-active: #2563eb;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --ynab-blue: #2563eb;
      --ynab-dark-blue: #1d4ed8;
      --ynab-light-blue: #dbeafe;
      --ynab-green: #16a34a;
      --ynab-red: #dc2626;
      --ynab-orange: #ea580c;
      --ynab-yellow: #ca8a04;
      --ynab-border: #cbd5e1;
      --ynab-light-gray: rgba(248, 250, 252, 0.8);
      --ynab-text: #1e293b;
      --ynab-text-light: #64748b;
      --ynab-bg-secondary: rgba(248, 250, 252, 0.8);
      --theme-name: "Koopa Beach";
    }

    /* Choco Mountain Theme */
    [data-theme="choco-mountain"] {
      --bg: #8b4513;
      --card-bg: #d2691e;
      --primary: #ff8c00;
      --primary-hover: #ff7f00;
      --secondary: #deb887;
      --text: #fffaf0;
      --text-light: #f5deb3;
      --shadow: 0 2px 8px rgba(0,0,0,0.4);
      --header-bg: #cd853f;
      --header-text: #fffaf0;
      --sidebar-bg: #a0522d;
      --sidebar-text: #f5deb3;
      --sidebar-hover: #cd853f;
      --sidebar-active: #ff8c00;
      --danger: #dc143c;
      --danger-hover: #b91c1c;
      --ynab-blue: #ff8c00;
      --ynab-dark-blue: #ff7f00;
      --ynab-light-blue: #deb887;
      --ynab-green: #32cd32;
      --ynab-red: #dc143c;
      --ynab-orange: #ff8c00;
      --ynab-yellow: #ffd700;
      --ynab-border: #cd853f;
      --ynab-light-gray: #deb887;
      --ynab-text: #fffaf0;
      --ynab-text-light: #f5deb3;
      --ynab-bg-secondary: #deb887;
      --theme-name: "Choco Mountain";
    }

    /* Moo Moo Farm Theme */
    [data-theme="moo-moo-farm"] {
      --bg: #90ee90;
      --card-bg: #ffffff;
      --primary: #228b22;
      --primary-hover: #006400;
      --secondary: #f0fff0;
      --text: #2f4f2f;
      --text-light: #556b2f;
      --shadow: 0 2px 8px rgba(34, 139, 34, 0.2);
      --header-bg: #ffffff;
      --header-text: #2f4f2f;
      --sidebar-bg: #f5fffa;
      --sidebar-text: #556b2f;
      --sidebar-hover: #f0fff0;
      --sidebar-active: #228b22;
      --danger: #dc143c;
      --danger-hover: #b91c1c;
      --ynab-blue: #228b22;
      --ynab-dark-blue: #006400;
      --ynab-light-blue: #f0fff0;
      --ynab-green: #32cd32;
      --ynab-red: #dc143c;
      --ynab-orange: #ff8c00;
      --ynab-yellow: #ffd700;
      --ynab-border: #98fb98;
      --ynab-light-gray: #f5fffa;
      --ynab-text: #2f4f2f;
      --ynab-text-light: #556b2f;
      --ynab-bg-secondary: #f5fffa;
      --theme-name: "Moo Moo Farm";
    }

    /* Bowser's Castle Theme */
    [data-theme="bowsers-castle"] {
      --bg: #1a0a0a;
      --card-bg: #3a1a1a;
      --primary: #ff4500;
      --primary-hover: #ff6347;
      --secondary: #2a0a0a;
      --text: #ff6b6b;
      --text-light: #ff8e8e;
      --shadow: 0 2px 8px rgba(255, 69, 0, 0.3);
      --header-bg: #2a0a0a;
      --header-text: #ff6b6b;
      --sidebar-bg: #2a0a0a;
      --sidebar-text: #ff8e8e;
      --sidebar-hover: #3a1a1a;
      --sidebar-active: #ff4500;
      --danger: #8b0000;
      --danger-hover: #a00000;
      --ynab-blue: #ff4500;
      --ynab-dark-blue: #ff6347;
      --ynab-light-blue: #2a0a0a;
      --ynab-green: #ff8c00;
      --ynab-red: #8b0000;
      --ynab-orange: #ff4500;
      --ynab-yellow: #ffd700;
      --ynab-border: #4a2a2a;
      --ynab-light-gray: #3a1a1a;
      --ynab-text: #ff6b6b;
      --ynab-text-light: #ff8e8e;
      --ynab-bg-secondary: #3a1a1a;
      --theme-name: "Bowser's Castle";
    }

    /* Yoshi Valley Theme */
    [data-theme="yoshi-valley"] {
      --bg: linear-gradient(135deg, #98fb98 0%, #90ee90 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --primary: #32cd32;
      --primary-hover: #228b22;
      --secondary: #f0fff0;
      --text: #006400;
      --text-light: #228b22;
      --shadow: 0 2px 8px rgba(50, 205, 50, 0.2);
      --header-bg: rgba(255, 255, 255, 0.9);
      --header-text: #006400;
      --sidebar-bg: rgba(245, 255, 250, 0.95);
      --sidebar-text: #228b22;
      --sidebar-hover: #f0fff0;
      --sidebar-active: #32cd32;
      --danger: #dc143c;
      --danger-hover: #b91c1c;
      --ynab-blue: #32cd32;
      --ynab-dark-blue: #228b22;
      --ynab-light-blue: #f0fff0;
      --ynab-green: #00ff00;
      --ynab-red: #dc143c;
      --ynab-orange: #ff8c00;
      --ynab-yellow: #ffd700;
      --ynab-border: #90ee90;
      --ynab-light-gray: rgba(245, 255, 250, 0.8);
      --ynab-text: #006400;
      --ynab-text-light: #228b22;
      --ynab-bg-secondary: rgba(245, 255, 250, 0.8);
      --theme-name: "Yoshi Valley";
    }

    /* Rainbow Road Theme */
    [data-theme="rainbow-road"] {
      --bg: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57, #ff9ff3);
      --card-bg: rgba(255, 255, 255, 0.9);
      --primary: #6c5ce7;
      --primary-hover: #5f3dc4;
      --secondary: rgba(108, 92, 231, 0.1);
      --text: #2d3436;
      --text-light: #636e72;
      --shadow: 0 4px 20px rgba(108, 92, 231, 0.3);
      --header-bg: rgba(255, 255, 255, 0.95);
      --header-text: #2d3436;
      --sidebar-bg: rgba(255, 255, 255, 0.95);
      --sidebar-text: #636e72;
      --sidebar-hover: rgba(108, 92, 231, 0.1);
      --sidebar-active: #6c5ce7;
      --danger: #e17055;
      --danger-hover: #d63031;
      --ynab-blue: #6c5ce7;
      --ynab-dark-blue: #5f3dc4;
      --ynab-light-blue: rgba(108, 92, 231, 0.1);
      --ynab-green: #00b894;
      --ynab-red: #e17055;
      --ynab-orange: #fdcb6e;
      --ynab-yellow: #ffeaa7;
      --ynab-border: rgba(108, 92, 231, 0.2);
      --ynab-light-gray: rgba(255, 255, 255, 0.8);
      --ynab-text: #2d3436;
      --ynab-text-light: #636e72;
      --ynab-bg-secondary: rgba(255, 255, 255, 0.8);
      --theme-name: "Rainbow Road";
    }

    /* Lobster Life Theme */
    [data-theme="lobster-life"] {
      --bg: #ff6b6b;
      --card-bg: #ffffff;
      --primary: #ee5a24;
      --primary-hover: #d63031;
      --secondary: #fab1a0;
      --text: #2d3436;
      --text-light: #636e72;
      --shadow: 0 2px 8px rgba(238, 90, 36, 0.2);
      --header-bg: #ffffff;
      --header-text: #2d3436;
      --sidebar-bg: #ffeaa7;
      --sidebar-text: #636e72;
      --sidebar-hover: #fab1a0;
      --sidebar-active: #ee5a24;
      --danger: #d63031;
      --danger-hover: #b91c1c;
      --ynab-blue: #ee5a24;
      --ynab-dark-blue: #d63031;
      --ynab-light-blue: #fab1a0;
      --ynab-green: #00b894;
      --ynab-red: #d63031;
      --ynab-orange: #fdcb6e;
      --ynab-yellow: #ffeaa7;
      --ynab-border: #fab1a0;
      --ynab-light-gray: #ffeaa7;
      --ynab-text: #2d3436;
      --ynab-text-light: #636e72;
      --ynab-bg-secondary: #ffeaa7;
      --theme-name: "Lobster Life";
    }

    /* Hacker News Theme */
    [data-theme="hacker-news"] {
      --bg: #f6f6ef;
      --card-bg: #ffffff;
      --primary: #ff6600;
      --primary-hover: #e55a00;
      --secondary: #f6f6ef;
      --text: #000000;
      --text-light: #828282;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --header-bg: #ff6600;
      --header-text: #ffffff;
      --sidebar-bg: #f6f6ef;
      --sidebar-text: #000000;
      --sidebar-hover: #ffffff;
      --sidebar-active: #ff6600;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --ynab-blue: #ff6600;
      --ynab-dark-blue: #e55a00;
      --ynab-light-blue: #f6f6ef;
      --ynab-green: #00a000;
      --ynab-red: #dc2626;
      --ynab-orange: #ff6600;
      --ynab-yellow: #ffb000;
      --ynab-border: #cccccc;
      --ynab-light-gray: #f6f6ef;
      --ynab-text: #000000;
      --ynab-text-light: #828282;
      --ynab-bg-secondary: #f6f6ef;
      --theme-name: "Hacker News";
    }

    /* === Base Styles === */
    * { 
      box-sizing: border-box; 
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      flex-direction: column;
      font-size: 14px;
      line-height: 1.5;
      transition: all 0.3s ease;
    }

/* === Theme Selector === */
.theme-selector {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
}

.theme-toggle {
  background: var(--card-bg);
  border: 2px solid var(--ynab-border);
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--text);
  transition: all 0.2s ease;
  position: relative;
}

.theme-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Dropdown container */
.theme-dropdown {
  background: var(--card-bg);
  border: 2px solid var(--ynab-border);
  border-radius: 10px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  min-width: 220px;
  margin-top: 8px;
  overflow: hidden;
  position: absolute;
  top: 100%;
  right: 0;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  z-index: 30;
}

.theme-dropdown.open {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

/* Theme options */
.theme-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  cursor: pointer;
  width: 100%;
  border: none;
  background: none;
  text-align: left;
  font-size: 14px;
  font-weight: 500;
  position: relative;
  color: var(--text);           /* Use main text color */
  transition: background 0.2s ease, color 0.2s ease;
  opacity: 1;                   /* Make fully visible */
}

.theme-option:hover {
  background: rgba(0, 0, 0, 0.05); /* Light gray hover */
  color: var(--primary);
}

.theme-option.active {
  background: var(--primary);
  color: #ffffff;
  font-weight: 600;
}

/* Preview icon */
.theme-preview {
  width: 18px;
  height: 18px;
  border-radius: 4px;
  border: 1px solid rgba(0,0,0,0.2);
  flex-shrink: 0;
  box-shadow: 0 0 2px rgba(0,0,0,0.2) inset;
}

/* Gradient previews */
.theme-preview.classic        { background: linear-gradient(45deg, #005ca9, #e8f2ff); }
.theme-preview.dark           { background: linear-gradient(45deg, #4a9eff, #2d2d2d); }
.theme-preview.koopa-beach    { background: linear-gradient(45deg, #2563eb, #fef7cd); }
.theme-preview.choco-mountain { background: linear-gradient(45deg, #ff8c00, #8b4513); }
.theme-preview.moo-moo-farm   { background: linear-gradient(45deg, #228b22, #90ee90); }
.theme-preview.bowsers-castle { background: linear-gradient(45deg, #ff4500, #1a0a0a); }
.theme-preview.yoshi-valley   { background: linear-gradient(45deg, #32cd32, #98fb98); }
.theme-preview.rainbow-road   { background: linear-gradient(45deg, #6c5ce7, #ff6b6b, #4ecdc4); }
.theme-preview.lobster-life   { background: linear-gradient(45deg, #ee5a24, #ff6b6b); }
.theme-preview.hacker-news    { background: linear-gradient(45deg, #ff6600, #f6f6ef); }

/* === Button Styles === */
.btn {
  padding: 10px 16px;
  border: none;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-family: inherit;
}

.btn-primary {
  background: var(--ynab-blue);
  color: white;
  border: 1px solid var(--ynab-blue);
}

.btn-primary:hover {
  background: var(--ynab-dark-blue);
  border-color: var(--ynab-dark-blue);
  transform: translateY(-1px);
}

.btn-secondary {
  background: white;
  color: var(--ynab-blue);
  border: 1px solid var(--ynab-border);
}

.btn-secondary:hover {
  background: var(--ynab-light-blue);
  border-color: var(--ynab-blue);
}


/* === Rollover Button (Theme Aware + Special Effects) === */
.rollover-container {
  position: relative;
}
/* ===== Rollover Button ===== */
.rollover-btn {
  position: relative;
  display: inline-block;
  padding: 18px 36px;
  font-size: 16px;
  font-weight: 600;
  letter-spacing: 0.025em;
  color: #fff;
  background: linear-gradient(
    135deg,
    var(--primary, #1e293b),
    color-mix(in srgb, var(--primary, #1e293b) 60%, #000 40%)
  );
  border: 2px solid color-mix(in srgb, var(--primary, #1e293b) 60%, #fff 20%);
  border-radius: 10px;
  cursor: pointer;
  text-decoration: none;
  outline: none;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
  isolation: isolate;
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* Background overlay animation */
.rollover-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    135deg,
    var(--primary-hover, #3b82f6),
    color-mix(in srgb, var(--primary-hover, #3b82f6) 60%, #8b5cf6 40%)
  );
  transition: left 0.6s ease;
  z-index: -1;
}

/* Hover state */
.rollover-btn:hover {
  transform: translateY(-2px);
  border-color: var(--primary-hover, #3b82f6);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.rollover-btn:hover::before {
  left: 0;
}

/* Active state */
.rollover-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 10px rgba(59, 130, 246, 0.6), inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Focus state */
.rollover-btn:focus-visible {
  outline: 2px solid var(--primary-hover, #3b82f6);
  outline-offset: 2px;
}

/* Text animation */
.rollover-btn .btn-text {
  position: relative;
  z-index: 1;
  display: inline-block;
  transition: transform 0.3s ease;
}

.rollover-btn:hover .btn-text {
  transform: scale(1.05);
}

/* Loading state */
.rollover-btn.loading {
  pointer-events: none;
  opacity: 0.85;
}

.rollover-btn.loading::before {
  left: 0;
  background: linear-gradient(135deg, #f59e0b, #d97706);
}

.rollover-btn.loading .btn-text {
  animation: pulse 1.5s ease-in-out infinite;
}

/* Success state */
.rollover-btn.success::before {
  left: 0;
  background: linear-gradient(135deg, #10b981, #059669);
}

.rollover-btn.success {
  border-color: #10b981;
}

/* Pulse animation */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

/* Ripple effect */
.rollover-btn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 1.2s ease-out, height 1.2s ease-out, opacity 1.2s ease-out;
  z-index: 0;
  pointer-events: none;
}

.rollover-btn:active::after {
  width: 300px;
  height: 300px;
  opacity: 0;
}

/* Ripple keyframes for click enhancement */
@keyframes ripple {
  to {
    transform: scale(2.5);
    opacity: 0;
  }
}









 /* === Sidebar === */
    .sidebar {
      width: 200px;
      height: 100vh;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--ynab-border);
      padding: 0;
      position: fixed;
      top: 0; 
      left: 0;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 8px rgba(0,0,0,0.06);
      transition: all 0.3s ease;
    }

    .sidebar h1 {
      font-size: 20px;
      font-weight: 700;
      text-align: center;
      margin: 24px 0 32px 0;
      color: var(--primary);
      padding: 0 20px;
    }

    .sidebar a {
      padding: 14px 24px;
      color: var(--sidebar-text);
      text-decoration: none;
      font-weight: 500;
      display: block;
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .sidebar a:hover {
      background: var(--sidebar-hover);
      border-left-color: var(--sidebar-active);
      color: var(--sidebar-active);
    }

    .sidebar a.active {
      background: var(--sidebar-hover);
      border-left-color: var(--sidebar-active);
      color: var(--sidebar-active);
      font-weight: 600;
    }

/* Push logout to bottom */
.logout-link {
  margin-top: auto;       /* pushes it to bottom */
  color: #f87171;         /* optional: red color for logout */
}



   /* === Main Content === */
    .main-content {
      margin-left: 240px;
      width: calc(100% - 240px);
      padding: 24px 32px;
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      transition: all 0.3s ease;
    }

/* === Actions Section === */
.actions {
  display: flex;
  gap: 12px;
  margin: 20px 0;
}

.actions button {
  background: var(--primary);
  color: #fff;
  border: 1px solid var(--primary);
  border-radius: var(--radius);
  padding: 12px 18px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: all 0.2s ease;
  font-family: inherit;
}

.actions button:hover {
  background: var(--primary-hover);
  border-color: var(--primary-hover);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* === Month Filter === */
#monthFilter {
  width: 100%;
  padding: 12px 16px;
  font-size: 14px;
  border: 2px solid var(--ynab-border);
  border-radius: var(--radius);
  background: #fff;
  box-shadow: var(--shadow);
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  font-family: inherit;
}

#monthFilter:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 92, 169, 0.15);
}

   /* === Header === */
   header {
  background: var(--header-bg);
  color: var(--header-text);
  padding: 20px 24px;
  font-weight: 600;
  font-size: 18px;
  border-radius: var(--radius);
  margin-bottom: 24px;
  display: flex;
  justify-content: flex-start;  /* ⬅ align all content to the left */
  align-items: center;
  gap: 16px;                     /* ⬅ space between button and title */
  box-shadow: var(--shadow);
  border: 1px solid var(--ynab-border);
  transition: all 0.3s ease;
}

header button {
  background: var(--primary);
  color: #fff;
  border: 1px solid var(--primary);
  border-radius: var(--radius);
  padding: 10px 16px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 600;
  font-family: inherit;
  margin-left: 0;  /* ⬅ make sure it's not pushed to the right */
}

header button:hover { 
  background: var(--primary-hover); 
  border-color: var(--primary-hover);
}

/* === Cards === */
 .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      border: 1px solid var(--ynab-border);
      transition: all 0.3s ease;
    }

h2 {
  margin: 0 0 16px;
  font-size: 18px;
  font-weight: 600;
  color: var(--ynab-text);
}

h3 {
  margin: 0 0 12px;
  font-size: 16px;
  font-weight: 600;
  color: var(--ynab-text);
}

/* === Summary === */
.summary {
  display: flex;
  justify-content: space-between;
  gap: 20px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.summary div {
  flex: 1 1 200px;
  background: var(--secondary);
  border-radius: var(--radius);
  padding: 20px;
  text-align: center;
  box-shadow: var(--shadow);
  border: 1px solid var(--ynab-border);
}

/* === Budget Grid === */
.budget-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  margin-top: 16px;
  align-items: stretch;
}

.budget-item {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  min-height: 180px;
  box-sizing: border-box;
  border: 1px solid var(--ynab-border);
}

.budget-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.pill {
  background: var(--ynab-light-blue);
  color: var(--primary);
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.amounts {
  display: flex;
  justify-content: space-between;
  margin-top: 12px;
}

.amounts strong {
  display: block;
  font-size: 16px;
  color: var(--text);
}

/* === Budget Table === */
.budget-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.budget-table th, .budget-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid var(--ynab-border);
}

.budget-table th {
  background: var(--ynab-light-gray);
  font-weight: 600;
  color: var(--ynab-text);
}

.budget-table tr:hover {
  background-color: var(--ynab-light-gray);
}


/* === Transaction History === */
.transactions-container {
  margin-top: 20px;
}

/* Scrollable table wrapper */
.transactions-wrapper {
  max-height: 400px;          /* limit height */
  overflow-y: auto;            /* enable vertical scrolling */
  border: 1px solid var(--ynab-border);
  border-radius: 8px;
}

/* Table styles */
.transactions-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

/* Sticky table header */
.transactions-table thead {
  position: sticky;
  top: 0;
  z-index: 5;
  background: var(--ynab-light-gray);
  font-weight: 600;
  color: var(--ynab-text);
}

.transactions-table th,
.transactions-table td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--ynab-border);
  text-align: left;
}

.transactions-table td.amount-outflow {
  text-align: right;
  color: var(--danger);
  font-weight: 600;
}

.transactions-table td.amount-inflow {
  text-align: right;
  color: var(--ynab-green);
  font-weight: 600;
}

.transactions-table th:nth-child(4),
.transactions-table th:nth-child(5) {
  text-align: right;
}

.transactions-table tr:hover {
  background: var(--ynab-light-gray);
}

/* Custom scrollbar */
.transactions-wrapper::-webkit-scrollbar {
  width: 8px;
}

.transactions-wrapper::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

.transactions-wrapper::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}













/* === Accounts Section === */
#accounts {
  padding: 24px;
}

#accounts header span {
  font-size: 24px;
  font-weight: 600;
  color: var(--text);
}

#accounts .card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  margin-top: 20px;
  border: 1px solid var(--ynab-border);
}

#accounts h2 {
  font-size: 18px;
  margin-bottom: 20px;
  color: var(--text);
}

#accounts-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 16px;
}

.account-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border: 1px solid var(--ynab-border);
  border-radius: var(--radius);
  background: var(--ynab-light-gray);
  transition: background 0.2s ease;
}

.account-item:hover {
  background: var(--ynab-bg-secondary);
}

.account-item strong {
  font-weight: 600;
  font-size: 16px;
}

.account-item .sub {
  color: var(--ynab-text-light);
  font-size: 14px;
  margin-top: 4px;
}


.account-actions button {
  margin-left: 8px;
  padding: 8px 16px;
  border-radius: var(--radius);
  font-weight: 500;
  cursor: pointer;
  background: var(--primary);
  color: #ffffff; /* force readable text */
  border: 1px solid var(--primary);
  transition: all 0.2s ease;
  font-family: inherit;
}

.account-actions button:hover {
  background: var(--primary-hover);
  border-color: var(--primary-hover);
  color: #ffffff; /* keep text visible */
}



#add-account-btn {
  margin-top: 20px;
  padding: 12px 20px;
  border-radius: var(--radius);
  font-weight: 600;
  cursor: pointer;
  background: var(--primary);
  color: #fff;
  border: 1px solid var(--primary);
  transition: all 0.2s ease;
  font-family: inherit;
}

#add-account-btn:hover {
  background: var(--primary-hover);
  border-color: var(--primary-hover);
}

.accounts-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

/* === Enhanced Button Styles === */
.btn-sm {
  padding: 8px 12px;
  font-size: 13px;
}

.btn-outline {
  background: white;
  border: 1px solid var(--ynab-border);
  color: var(--ynab-text);
}

.btn-outline:hover {
  background: var(--ynab-light-gray);
  border-color: var(--ynab-blue);
}

.btn-danger {
  background: var(--ynab-red);
  color: #fff;
  border: 1px solid var(--ynab-red);
}

.btn-danger:hover {
  background: #c53030;
  border-color: #c53030;
}

/* === Modal Styles === */
.modal {
  position: fixed;
  top: 0; 
  left: 0;
  width: 100%; 
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(2px);
}

.modal.hidden {
  display: none;
}
/* === Global Themed Modal Fix === */
.modal-content {
  background: var(--card-bg) !important;
  color: var(--text) !important;
  border: 1px solid var(--ynab-border);
  border-radius: var(--radius);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
}

.modal-content h2,
.modal-content h3,
.modal-content .modal-title {
  color: var(--text) !important;
}

.modal-content label {
  color: var(--text) !important;
  font-weight: 600;
}

.modal-content input,
.modal-content select,
.modal-content textarea {
  background: var(--card-bg) !important;
  color: var(--text) !important;
  border: 2px solid var(--ynab-border);
  border-radius: var(--radius);
  padding: 12px 16px;
  font-family: inherit;
  transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
}

.modal-content input:focus,
.modal-content select:focus,
.modal-content textarea:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 92, 169, 0.15);
}

.modal-actions button {
  border-radius: var(--radius);
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  transition: background 0.2s ease, color 0.2s ease;
}

.modal-actions button:first-child {
  background: var(--ynab-light-gray);
  color: var(--text);
  border: 1px solid var(--ynab-border);
}

.modal-actions button:first-child:hover {
  background: var(--ynab-bg-secondary);
}

.modal-actions .btn-primary {
  background: var(--primary);
  color: #fff;
  border: 1px solid var(--primary);
}

.modal-actions .btn-primary:hover {
  background: var(--primary-hover);
  border-color: var(--primary-hover);
}

.modal .close {
  color: var(--ynab-text-light);
  transition: color 0.2s ease;
}

.modal .close:hover {
  color: var(--text);
}


@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

/* === Category Summary List === */
.category-summary-list {
  list-style: none;
  padding: 0;
  margin: 0 0 20px 0;
}

.category-summary-list li {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid var(--ynab-border);
}

.category-summary-list li span:first-child {
  font-weight: 500;
}

.category-summary-list li span:last-child {
  font-weight: 600;
}

.category-summary-list li.negative span:last-child {
  color: var(--ynab-red);
}

.category-summary-list li.positive span:last-child {
  color: var(--ynab-green);
}

.modal-footer {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

#category-dropdown {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--ynab-border);
  border-radius: var(--radius);
  font-family: inherit;
}

.modal-title {
  margin: 0 0 20px 0;
  font-size: 18px;
  font-weight: 600;
}

.btn.cancel {
  background: var(--ynab-light-gray);
  color: var(--ynab-text);
  border: 1px solid var(--ynab-border);
}

.btn.ok {
  background: var(--ynab-blue);
  color: #fff;
  border: 1px solid var(--ynab-blue);
}

/* === Transaction Items === */
.transaction-item {
  display: flex;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid var(--ynab-border);
}

.tx-left {
  flex: 1;
  font-size: 14px;
}

.tx-date {
  font-weight: 600;
  color: var(--ynab-text);
}

.tx-type {
  font-style: italic;
  color: var(--ynab-text-light);
}

.tx-right {
  display: flex;
  justify-content: flex-end;
  align-items: center;
}

.tx-amount {
  font-size: 16px;
  font-weight: 600;
  margin-right: 16px;
}

.tx-amount.outflow {
  color: var(--ynab-red);
}

.tx-amount.inflow {
  color: var(--ynab-green);
}

.delete-tx-btn {
  background: transparent;
  border: none;
  color: var(--ynab-red);
  cursor: pointer;
  font-size: 18px;
  font-weight: bold;
  transition: color 0.2s ease;
}

.delete-tx-btn:hover {
  color: #c53030;
}

/* === Toast Notifications === */
.toast {
  background: var(--ynab-blue);
  color: white;
  padding: 16px 20px;
  border-radius: var(--radius);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  opacity: 0;
  transform: translateY(-10px);
  transition: all 0.3s ease;
  font-size: 14px;
  min-width: 260px;
  font-weight: 500;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.toast.error {
  background: var(--ynab-red);
}

.toast.success {
  background: var(--ynab-green);
}

/* === Report Section (Theme Aware) === */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 32px;
  background: var(--card-bg);
  color: var(--text);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}

.report-nav {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 32px;
  overflow: hidden;
  border: 1px solid var(--ynab-border);
}

.report-tabs {
  display: flex;
  border-bottom: 1px solid var(--ynab-border);
}

.report-tab {
  flex: 1;
  padding: 18px 24px;
  background: none;
  border: none;
  font-size: 14px;
  font-weight: 600;
  color: var(--ynab-text-light);
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  font-family: inherit;
}

.report-tab:hover {
  background: var(--ynab-bg-secondary);
  color: var(--ynab-text);
}

.report-tab.active {
  color: var(--ynab-blue);
  background: var(--ynab-light-blue);
}

.report-tab.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--ynab-blue);
}

.filter-panel {
  background: var(--card-bg);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-bottom: 32px;
  display: flex;
  gap: 20px;
  align-items: end;
  flex-wrap: wrap;
  border: 1px solid var(--ynab-border);
}

/* Theme-aware inputs and selects */
.form-input,
#reports select.form-input,
#reports input[type="date"] {
  padding: 12px 16px;
  border: 2px solid var(--ynab-border);
  border-radius: var(--radius);
  font-size: 14px;
  font-family: inherit;
  background: var(--card-bg);
  color: var(--text);
  transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
}

#reports select.form-input option {
  background: var(--card-bg);
  color: var(--text);
}

.form-input:focus,
#reports select.form-input:focus,
#reports input[type="date"]:focus {
  outline: none;
  border-color: var(--ynab-blue);
}

.report-content {
  display: none;
}

.report-content.active {
  display: block;
}

.report-layout {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 32px;
  margin-bottom: 40px;
}

@media (max-width: 768px) {
  .report-layout {
    grid-template-columns: 1fr;
  }
}

.chart-container {
  background: var(--card-bg);
  padding: 32px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--ynab-border);
}

.chart-container canvas {
  width: 100% !important;
  height: 300px !important;
  display: block;
}

.chart-header {
  margin-bottom: 24px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--ynab-border);
}

.chart-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 6px;
}

.chart-subtitle {
  font-size: 13px;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.summary-panel {
  background: var(--card-bg);
  padding: 32px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--ynab-border);
}

.summary-header {
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--ynab-border);
}

.summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0;
  border-bottom: 1px solid var(--ynab-light-gray);
}

.summary-item:last-child {
  border-bottom: none;
  font-weight: 600;
}

.summary-label {
  font-size: 14px;
  color: var(--text);
}

.summary-value {
  font-size: 14px;
  font-weight: 500;
  color: var(--text);
}

.summary-value.positive {
  color: var(--ynab-green);
}

.summary-value.negative {
  color: var(--ynab-red);
}

.metric-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 32px;
}

.metric-card {
  background: var(--card-bg);
  padding: 24px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  text-align: center;
  border: 1px solid var(--ynab-border);
}

.metric-value {
  font-size: 28px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--text);
}

.metric-label {
  font-size: 13px;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.category-breakdown {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  border: 1px solid var(--ynab-border);
}

.breakdown-header {
  padding: 24px 32px;
  border-bottom: 1px solid var(--ynab-border);
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
}

.breakdown-list {
  max-height: 400px;
  overflow-y: auto;
}

.breakdown-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 32px;
  border-bottom: 1px solid var(--ynab-light-gray);
  color: var(--text);
}

.breakdown-item:hover {
  background: var(--sidebar-hover);
}

.breakdown-category {
  display: flex;
  align-items: center;
  gap: 16px;
}

.category-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
}

.category-name,
.category-amount {
  font-size: 14px;
  color: var(--text);
}

.empty-state {
  text-align: center;
  padding: 80px 32px;
  color: var(--text-light);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 20px;
}

.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 60px;
  color: var(--text-light);
}

.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid var(--ynab-border);
  border-top: 3px solid var(--ynab-blue);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 16px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* === Goals Section === */
.goals-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* Goals Section Header - small height */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;        /* spacing below header */
  background: var(--card-bg);
  padding: 40px;           /* very small padding */
  height: 20px;                /* fixed small height */
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--ynab-border);
  box-sizing: border-box;
  font-size: 14px;             /* optional smaller text */
}


.header h1 {
  color: var(--text);
  font-size: 28px;
  font-weight: 600;
}

.add-goal-btn {
  background: var(--primary);
  color: #fff;
  border: 1px solid var(--primary);
  padding: 12px 24px;
  border-radius: var(--radius);
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s, transform 0.2s;
  margin-left: auto;
}

.add-goal-btn:hover {
  background: var(--primary-hover);
  border-color: var(--primary-hover);
  transform: translateY(-1px);
}

.goals-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.goal-card {
  background: var(--card-bg);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--ynab-border);
  border-left: 4px solid var(--primary);
  transition: transform 0.2s, box-shadow 0.2s;
}

.goal-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.goal-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
}

.goal-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.goal-type {
  font-size: 12px;
  color: var(--text-light);
  text-transform: uppercase;
  font-weight: 500;
  letter-spacing: 0.5px;
}

.goal-actions {
  display: flex;
  gap: 8px;
}

.action-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-light);
  padding: 4px;
  border-radius: 4px;
  transition: color 0.2s, background 0.2s;
}

.action-btn:hover {
  color: var(--text);
  background: var(--ynab-light-gray);
}

/* Progress Bar */
.progress-bar {
  width: 100%;
  height: 14px;
  background: var(--ynab-light-gray);
  border-radius: 50px;
  overflow: hidden;
  margin-bottom: 16px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--ynab-green), var(--primary));
  background-size: 200% 100%;
  border-radius: 50px;
  width: 0%;
  animation: progressShimmer 2s linear infinite;
  transition: width 0.6s ease-in-out;
}

@keyframes progressShimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.progress-text {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  color: var(--text-light);
}

/* Amounts & Details */
.amount-label {
  font-size: 12px;
  color: var(--text-light);
  text-transform: uppercase;
  font-weight: 500;
}

.amount-value {
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
}

.goal-details {
  font-size: 14px;
  color: var(--text-light);
  line-height: 1.4;
}

/* Goal Status Pills */
.status-active    { background: var(--ynab-light-blue); color: var(--ynab-green); }
.status-completed { background: var(--ynab-light-blue); color: var(--primary); }
.status-paused    { background: #fff3cd; color: #856404; } /* keep yellow for paused */

/* Add Funds Section */
.add-funds-section {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--ynab-border);
  display: flex;
  gap: 12px;
  align-items: center;
}

.funds-input {
  flex: 1;
  border: 1px solid var(--ynab-border);
  padding: 8px 12px;
  border-radius: var(--radius);
  font-size: 14px;
  color: var(--text);
  background: var(--card-bg);
}

.add-funds-btn {
  background: var(--ynab-green);
  color: #fff;
  border: 1px solid var(--ynab-green);
  padding: 8px 16px;
  border-radius: var(--radius);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}

.add-funds-btn:hover {
  background: #138d75;
}


        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #005a9c;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        /* === Buttons === */
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: 1px solid var(--primary);
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      transform: translateY(-1px);
    }


        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background: #d5dbdb;
        }


 /* === Demo Content === */
    .demo-section {
      margin-bottom: 32px;
    }

    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .demo-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--ynab-border);
      transition: all 0.3s ease;
    }

    .demo-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }

    .current-theme {
      background: var(--secondary);
      padding: 12px 16px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      border: 1px solid var(--ynab-border);
      font-weight: 600;
      color: var(--text);
    }

    /* === Responsive === */
    @media (max-width: 768px) {
      .theme-selector {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 20px;
      }
      
      .sidebar {
        width: 200px;
      }
      
      .main-content {
        margin-left: 200px;
        width: calc(100% - 200px);
        padding: 16px 20px;
      }
    }

    @media (max-width: 480px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .main-content {
        margin-left: 0;
        width: 100%;
      }
    }


























        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .empty-text {
            color: #7f8c8d;
            margin-bottom: 24px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #16a085;
        }

        .toast.error {
            background: #e74c3c;
        }


/* === Settings Section === */
#settings {
  display: flex;
  flex-direction: column;
  width: 100%;
  min-height: 100vh;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  box-sizing: border-box;
}

/* === Header === */
#settings header.settings-header {
  /* removed fixed positioning */
  margin-left: 220px;                   /* align with sidebar */
  height: 72px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 32px;
  box-sizing: border-box;
  border-bottom: 1px solid var(--ynab-border);
  background: var(--header-bg);
  color: var(--header-text);
  box-shadow: var(--shadow);
}

#settings header.settings-header span {
  font-size: 26px;
  font-weight: 700;
  color: var(--header-text);
  letter-spacing: -0.02em;
}

/* === Main container (sidebar + content) === */
.settings-container {
  display: flex;
  flex: 1;
  min-height: calc(100vh - 72px);
  padding: 32px;
  gap: 32px;
  margin-left: 220px;            /* same as sidebar width */
  background: var(--bg);
}

/* === Sidebar === */
.settings-sidebar {
  width: 260px;
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--ynab-border);
  height: fit-content;
}

.settings-sidebar ul {
  list-style: none;
  padding: 12px 0;
  margin: 0;
}

.settings-sidebar li {
  padding: 16px 20px;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
  color: var(--text);
  transition: all 0.25s ease;
  display: flex;
  align-items: center;
  border-radius: var(--radius);
  margin: 4px 12px;
}

.settings-sidebar li:hover {
  background: var(--sidebar-hover);
  color: var(--primary);
  transform: translateX(4px);
}

.settings-sidebar li.active {
  background: var(--primary);
  color: #fff;
  font-weight: 700;
  box-shadow: 0 4px 10px rgba(0, 91, 163, 0.3);
}

/* === Content area === */
.settings-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

/* === Card appearance === */
#settings .card {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 32px;
  border: 1px solid var(--ynab-border);
  color: var(--text);
  transition: all 0.3s ease;
}

#settings .card:hover {
  box-shadow: var(--shadow);
  transform: translateY(-2px);
}

/* === Section headers inside cards === */
.section-header {
  margin-bottom: 28px;
  border-bottom: 2px solid var(--ynab-border);
  padding-bottom: 12px;
}

.section-header h2 {
  font-size: 22px;
  font-weight: 700;
  margin: 0;
  color: var(--text);
  letter-spacing: -0.02em;
}

/* === Form groups === */
#settings .form-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 24px;
}

#settings .form-group label {
  font-weight: 600;
  margin-bottom: 6px;
  color: var(--text-light);
  font-size: 13px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

#settings .form-group input,
#settings .form-group select {
  padding: 14px 16px;
  border: 1px solid var(--ynab-border);
  border-radius: var(--radius);
  font-size: 15px;
  background: var(--card-bg);
  color: var(--text);
  transition: all 0.3s ease;
  font-family: inherit;
}

#settings .form-group input:focus,
#settings .form-group select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 91, 163, 0.15);
}

#settings .form-group small {
  color: var(--text-light);
  margin-top: 6px;
  font-size: 12px;
  font-style: italic;
}

/* === Buttons (Theme-Aware) === */
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-family: inherit;
  box-shadow: var(--shadow);
}

/* Primary */
.btn-primary {
  background: var(--primary);
  color: #fff;
}

.btn-primary:hover {
  background: var(--primary-hover);
}

/* Secondary */
.btn-secondary {
  background: var(--secondary);
  color: var(--text);
}

.btn-secondary:hover {
  background: var(--sidebar-hover);
  color: var(--primary);
}

/* Danger */
.btn-danger {
  background: var(--danger);
  color: #fff;
}

.btn-danger:hover {
  background: var(--danger-hover);
}

/* === Section visibility === */
.settings-section {
  display: none;
}

.settings-section.active {
  display: block;
  animation: fadeInUp 0.4s ease-out;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(16px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* === Responsive sidebar === */
@media (max-width: 768px) {
  #settings header.settings-header {
    margin-left: 0;
    padding: 20px;
  }

  .settings-container {
    flex-direction: column;
    margin-left: 0;
    padding: 20px;
  }

  .settings-sidebar {
    width: 100%;
  }

  .settings-sidebar ul {
    display: flex;
    overflow-x: auto;
    gap: 8px;
    padding: 8px;
  }

  .settings-sidebar li {
    flex: 0 0 auto;
    text-align: center;
    white-space: nowrap;
    margin: 0;
  }

  .settings-content {
    width: 100%;
  }
}



/* === Footer === */
footer {
  background: var(--sidebar-bg);
  color: var(--sidebar-text);
  text-align: center;
  padding: 20px;
  border-top: 1px solid var(--ynab-border);
  font-size: 14px;
  margin-top: auto;
}

footer a {
  color: var(--sidebar-active);
  text-decoration: none;
  font-weight: 600;
  margin: 0 12px;
}

footer a:hover { 
  text-decoration: underline; 
}

/* === Enhanced Modal Overlay === */
.modal {
  display: flex;
  justify-content: center;
  align-items: center;
  position: fixed;
  z-index: 1000;
  inset: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.5);
  backdrop-filter: blur(6px);
  transition: opacity 0.3s ease;
}

/* Hidden state */
.hidden {
  display: none;
}

/* === Enhanced Modal Box === */
.modal-content {
  background: #fff;
  padding: 32px 36px;
  border-radius: 8px;
  min-width: 400px;
  max-width: 560px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.25);
  animation: fadeInUp 0.4s ease;
  position: relative;
  font-family: inherit;
  border: 1px solid var(--ynab-border);
}

/* Modal Header */
.modal-content h2 {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 20px;
  color: var(--ynab-text);
}

/* Close Button */
.close {
  position: absolute;
  top: 20px;
  right: 24px;
  font-size: 24px;
  cursor: pointer;
  color: var(--ynab-text-light);
  transition: color 0.2s ease;
  font-weight: bold;
}

.close:hover {
  color: var(--ynab-text);
}

/* Form Layout */
.modal-content label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: var(--ynab-text);
}

.modal-content input,
.modal-content select {
  width: 100%;
  padding: 12px 16px;
  margin-bottom: 18px;
  border: 2px solid var(--ynab-border);
  border-radius: var(--radius);
  font-size: 14px;
  transition: border-color 0.2s ease;
  font-family: inherit;
}

.modal-content input:focus,
.modal-content select:focus {
  outline: none;
  border-color: var(--ynab-blue);
  box-shadow: 0 0 0 3px rgba(0, 92, 169, 0.15);
}

/* Side-by-side inputs */
.split {
  display: flex;
  gap: 20px;
}

.split > div {
  flex: 1;
}

/* Modal Footer Buttons */
.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 16px;
}

.modal-actions button {
  padding: 12px 20px;
  border-radius: var(--radius);
  border: 1px solid transparent;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.25s ease;
  font-weight: 600;
  font-family: inherit;
}

.modal-actions button:hover {
  transform: translateY(-1px);
}

.modal-actions button:first-child {
  background: var(--ynab-light-gray);
  color: var(--ynab-text);
  border-color: var(--ynab-border);
}

.modal-actions button:first-child:hover {
  background: var(--ynab-bg-secondary);
}

.modal-actions .btn-primary {
  background: var(--ynab-blue);
  color: white;
  font-weight: 600;
  border-color: var(--ynab-blue);
}

.modal-actions .btn-primary:hover {
  background: var(--ynab-dark-blue);
  border-color: var(--ynab-dark-blue);
}

/* Animation */
@keyframes fadeInUp {
  from { 
    opacity: 0; 
    transform: translateY(24px) scale(0.95); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

/* === Responsive Design === */
@media (max-width: 768px) {
  .sidebar {
    width: 200px;
  }
  
  .main-content {
    margin-left: 200px;
    width: calc(100% - 200px);
    padding: 16px 20px;
  }
  
  .summary {
    flex-direction: column;
    gap: 16px;
  }
  
  .budget-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .modal-content {
    min-width: 320px;
    padding: 24px 28px;
  }
  
  .actions {
    flex-direction: column;
    align-items: stretch;
  }
}

 .main-content {
        margin-left: 200px;
        width: calc(100% - 200px);
        padding: 16px 20px;
      }
    }
  
  .card {
    padding: 16px;
  }
  
  header {
    padding: 16px 20px;
    font-size: 16px;
  }
}

/* === Additional YNAB-like Enhancements === */
.budget-item .category-name {
  font-weight: 600;
  font-size: 16px;
  color: var(--ynab-text);
}

.budget-item .category-balance {
  font-size: 18px;
  font-weight: 700;
}

.budget-item .category-balance.positive {
  color: var(--ynab-green);
}

.budget-item .category-balance.negative {
  color: var(--ynab-red);
}

.budget-item .category-balance.zero {
  color: var(--ynab-text-light);
}

.progress-section {
    margin-bottom: 28px;
    position: relative;
}

.progress-bar {
    width: 100%;
    height: 14px;
    background: #ecf0f1;
    border-radius: 50px;
    overflow: hidden;
    margin-bottom: 16px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);
    position: relative;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #16a085, #1abc9c, #2ecc71);
    background-size: 200% 100%;
    border-radius: 50px;
    width: 0%;
    animation: progressShimmer 2s linear infinite;
    box-shadow: 0 0 10px rgba(26, 188, 156, 0.4);
    transition: width 0.6s ease-in-out;
    position: relative;
}

@keyframes progressShimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.progress-label {
    position: absolute;
    top: -32px;
    transform: translateX(-50%);
    background: #1abc9c;
    color: white;
    font-size: 12px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 20px;
    white-space: nowrap;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    transition: left 0.6s ease;
    pointer-events: none;
}

.progress-text {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    color: #7f8c8d;
    padding-top: 4px;
}


/* === Status Indicators === */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 600;
  padding: 4px 8px;
  border-radius: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-indicator.on-track {
  background: rgba(56, 161, 105, 0.15);
  color: var(--ynab-green);
}

.status-indicator.over-budget {
  background: rgba(229, 62, 62, 0.15);
  color: var(--ynab-red);
}

.status-indicator.warning {
  background: rgba(237, 137, 54, 0.15);
  color: var(--ynab-orange);
}

/* === Hover Effects Enhancement === */
.budget-item:hover,
.account-item:hover,
.transaction-item:hover {
  cursor: pointer;
}

.sidebar a,
.budget-item,
.account-item,
.btn,
input,
select {
  -webkit-tap-highlight-color: transparent;
}

/* === Focus States === */
*:focus {
  outline: 2px solid var(--ynab-blue);
  outline-offset: 2px;
}

.btn:focus {
  outline-offset: 4px;
}

input:focus,
select:focus {
  outline: none;
}

/* === Print Styles === */
@media print {
  .sidebar {
    display: none;
  }
  
  .main-content {
    margin-left: 0;
    width: 100%;
  }
  
  .actions {
    display: none;
  }
  
  .modal {
    display: none;
  }
}







</style>

</head>
<body>


<!-- Theme Selector -->
  <div class="theme-selector">
    <button class="theme-toggle" id="themeToggle">
      🎨 <span id="currentThemeName">Classic</span>
    </button>
    <div class="theme-dropdown" id="themeDropdown">
      <button class="theme-option active" data-theme="classic">
        <div class="theme-preview classic"></div>
        Classic
      </button>
      <button class="theme-option" data-theme="dark">
        <div class="theme-preview dark"></div>
        Dark
      </button>
      <button class="theme-option" data-theme="koopa-beach">
        <div class="theme-preview koopa-beach"></div>
        Koopa Beach
      </button>
      <button class="theme-option" data-theme="choco-mountain">
        <div class="theme-preview choco-mountain"></div>
        Choco Mountain
      </button>
      <button class="theme-option" data-theme="moo-moo-farm">
        <div class="theme-preview moo-moo-farm"></div>
        Moo Moo Farm
      </button>
      <button class="theme-option" data-theme="bowsers-castle">
        <div class="theme-preview bowsers-castle"></div>
        Bowser's Castle
      </button>
      <button class="theme-option" data-theme="yoshi-valley">
        <div class="theme-preview yoshi-valley"></div>
        Yoshi Valley
      </button>
      <button class="theme-option" data-theme="rainbow-road">
        <div class="theme-preview rainbow-road"></div>
        Rainbow Road
      </button>
      <button class="theme-option" data-theme="lobster-life">
        <div class="theme-preview lobster-life"></div>
        Lobster Life
      </button>
      <button class="theme-option" data-theme="hacker-news">
        <div class="theme-preview hacker-news"></div>
        Hacker News
      </button>
    </div>
  </div>








!-- Sidebar -->
<div class="sidebar">
  <h1>BudgetMaster</h1>
  <a href="#dashboard" class="active">Dashboard</a>
  <a href="#accounts">Accounts</a>
  <a href="#budget">Budget</a>
  <a href="#reports">Reports</a>
  <a href="#goals">Goals</a>
  <a href="#settings">Settings</a>

  <!-- Logout link -->
  <a href="#logout" class="logout-link">Logout</a>
</div>

<!-- Main Content -->
<div class="main-content">
  <!-- ===== Dashboard Section ===== -->
  <section id="dashboard" class="section">
    <header>
      <span>Dashboard</span>
   <div class="rollover-container">
            <button class="rollover-btn" onclick="initiateRollover()" id="rolloverBtn">
                <span class="btn-text">Rollover</span>
            </button>
        </div>
    </header>

    <div class="current-theme">
      Current Theme: <span id="themeDisplay">Classic</span>
    </div>

    <!-- App Section -->
    <div id="appSection" style="display:none;">
        


      <!-- Month Filter -->
      <div style="max-width:400px; margin:20px auto;">
        <label for="monthFilter">Select Month:</label>
        <select id="monthFilter" onchange="filterByMonth()"></select>
      </div>

      <!-- Summary -->
      <div class="summary">
        <div><h3>To Be Budgeted</h3><p id="tbb">0</p></div>
        <div><h3>Total Assigned</h3><p id="assigned">0</p></div>
        <div><h3>Total Spent</h3><p id="spent">0</p></div>
        <div><h3>Overspent</h3><p id="overspent">0</p></div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button onclick="openModal('incomeModal')">+ Income</button>
        <button onclick="openModal('categoryModal')">+ Category</button>
        <button onclick="openModal('transactionModal')">+ Transaction</button>
      </div>

      <!-- Categories -->
      <div class="card">
        <h2>Budget Categories</h2>
        <div id="categories" class="budget-grid"></div>
      </div>

 <div class="transactions-container">
  <div class="transactions-wrapper">
    <table class="transactions-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Payee</th>
          <th>Category</th>
          <th>Outflow</th>
          <th>Inflow</th>
        </tr>
      </thead>
      <tbody id="transactionsBody">
        <!-- Transactions go here -->
      </tbody>
    </table>
  </div>
</div>
  </section>


<!-- ===== Accounts Section ===== -->
<section id="accounts" class="section">
  <header><span>Accounts</span></header>
  <div class="card">
    <div class="accounts-header">
      <h2>Your Accounts</h2>
      <button class="btn btn-primary" id="add-account-btn">+ Add Account</button>
    </div>

    <div id="accounts-list">
      <!-- Account items will render here -->
      <!-- Example:
      <div class="account-item">
        <div>
          <strong>BDO Checking</strong>
          <p class="sub">10,000.00</p>
        </div>
        <div class="account-actions">
          <button class="btn btn-sm btn-outline" onclick="openTransactionModal(0)">+ Transaction</button>
          <button class="btn btn-sm btn-danger" onclick="deleteAccount(0)">Delete</button>
        </div>
      </div>
      -->
    </div>
  </div>
</section>

<!-- 🏦 Add Account Modal -->
<div id="account-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeModal('account-modal')">&times;</span>
    <h2 id="account-modal-title">Add Account</h2>

    <div class="form-group">
      <label for="account-name">Account Name</label>
      <input type="text" id="account-name" placeholder="e.g. BDO Checking" />
    </div>

    <div class="form-group">
      <label for="account-balance">Balance</label>
      <input type="number" id="account-balance" placeholder="10000" />
    </div>

    <div class="modal-actions">
      <button class="btn" onclick="closeModal('account-modal')">Cancel</button>
      <button class="btn btn-primary" id="save-account-btn">Save</button>
    </div>
  </div>
</div>

<!-- 💳 Add Transaction Modal -->
<div id="transaction-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeModal('transaction-modal')">&times;</span>
    <h2>Add Transaction</h2>

    <div class="form-group">
      <label for="transaction-type">Type</label>
      <select id="transaction-type">
        <option value="deposit">Deposit</option>
        <option value="withdrawal">Withdrawal</option>
        <option value="transfer">Transfer</option>
      </select>
    </div>

    <div class="form-group">
      <label for="transaction-amount">Amount</label>
      <input type="number" id="transaction-amount" placeholder="1000" />
    </div>

    <div class="form-group">
      <label for="transaction-date">Date</label>
      <input type="date" id="transaction-date" />
    </div>

    <div class="form-group" id="transfer-target-group" style="display:none;">
      <label for="transfer-target">Transfer To</label>
      <select id="transfer-target"></select>
    </div>

    <div class="form-group">
      <label for="transaction-reason">Reason / Notes</label>
      <input type="text" id="transaction-reason" placeholder="e.g. Grocery shopping" />
    </div>

    <div class="modal-actions">
      <button class="btn" onclick="closeModal('transaction-modal')">Cancel</button>
      <button class="btn btn-primary" id="save-transaction-btn">Save Transaction</button>
    </div>
  </div>
</div>


<!-- ===== Accounts Section ===== -->
<section id="accounts" class="section">
  <header><span>Accounts</span></header>
  <div class="card">
    <div class="accounts-header">
      <h2>Your Accounts</h2>
      <button class="btn btn-primary" id="add-account-btn">+ Add Account</button>
    </div>

    <div id="accounts-list">
      <!-- Account items will render here -->
    </div>
  </div>
</section>



<!-- ===== Budget Section ===== --> 
<section id="budget" class="section">
  <header><span>Budget</span></header>
  <div class="card">
    <h2>Monthly Budget</h2>
    <table class="budget-table">
      <thead>
        <tr>
          <th></th> <!-- Checkbox column -->
          <th>Category</th>
          <th>Assigned Amount</th>
          <th>Amount Spent</th>
          <th>Remaining Balance</th>
        </tr>
      </thead>
      <tbody id="budget-table-body">
        <!-- Rows will be dynamically inserted here -->
      </tbody>
    </table>
  </div>
</section>

<!-- Modal for Category Transactions -->
<div id="category-modal" class="modal hidden">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal('category-modal')">&times;</span>
    <h3>Edit Category</h3>
    <label for="category-name-input">Category Name:</label>
    <input type="text" id="category-name-input" />
    <button id="save-category-btn">Save</button>
    <button id="delete-category-btn" style="background-color:red;color:white;">Delete Category</button>

    <h4>Transactions</h4>
    <ul id="category-transactions-list">
      <!-- Transactions for this category -->
    </ul>
  </div>
</div> 

<!-- ===== Reports Section ===== -->
<section id="reports" class="section" style="display:none;">
<header>
  <span>Reports</span>
  <button onclick="exportData()">Export</button>
</header>


  <div class="container">
    <nav class="report-nav">
      <div class="report-tabs">
        <button class="report-tab active" data-report="spending">Spending</button>
        <button class="report-tab" data-report="income-expense">Income vs Expenses</button>
        <button class="report-tab" data-report="net-worth">Net Worth</button>
        <button class="report-tab" data-report="trends">Spending Trends</button>
      </div>
    </nav>

    <div class="filter-panel">
      <div class="form-group">
        <label>Date Range</label>
        <select class="form-input" id="dateRange">
          <option value="current-month">Current Month</option>
          <option value="last-month">Last Month</option>
          <option value="last-3-months">Last 3 Months</option>
          <option value="last-6-months">Last 6 Months</option>
          <option value="current-year">Current Year</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="form-group" id="customDateRange" style="display: none;">
        <label>From Date</label>
        <input type="date" class="form-input" id="fromDate">
      </div>
      <div class="form-group" id="customDateRange2" style="display: none;">
        <label>To Date</label>
        <input type="date" class="form-input" id="toDate">
      </div>

     
  
      <button class="btn btn-primary" onclick="applyFilters()">Update Reports</button>
    </div>

    <!-- Spending Report -->
    <div id="report-spending" class="report-content active">
      <div class="metric-cards">
        <div class="metric-card">
          <div class="metric-value" id="total-spending">0</div>
          <div class="metric-label">Total Spending</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="avg-daily-spending">0</div>
          <div class="metric-label">Daily Average</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="top-category-spending">0</div>
          <div class="metric-label">Top Category</div>
        </div>
      </div>

      <div class="report-layout">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Spending by Category</div>
            <div class="chart-subtitle">Current period breakdown</div>
          </div>
          <canvas id="spendingChart"></canvas>
        </div>
        
        <div class="category-breakdown">
          <div class="breakdown-header">Category Details</div>
          <div class="breakdown-list" id="spendingBreakdown">
            <div class="loading">
              <div class="spinner"></div>
              Loading data...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Income vs Expenses Report -->
    <div id="report-income-expense" class="report-content">
      <div class="metric-cards">
        <div class="metric-card">
          <div class="metric-value positive" id="total-income">0</div>
          <div class="metric-label">Total Income</div>
        </div>
        <div class="metric-card">
          <div class="metric-value negative" id="total-expenses">0</div>
          <div class="metric-label">Total Expenses</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="net-income">0</div>
          <div class="metric-label">Net Income</div>
        </div>
      </div>

      <div class="report-layout">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Income vs Expenses</div>
            <div class="chart-subtitle">Monthly comparison</div>
          </div>
          <canvas id="incomeExpenseChart"></canvas>
        </div>

        <div class="summary-panel">
          <div class="summary-header">Summary</div>
          <div class="summary-item">
            <div class="summary-label">Income</div>
            <div class="summary-value positive" id="summary-income">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Expenses</div>
            <div class="summary-value negative" id="summary-expenses">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Net</div>
            <div class="summary-value" id="summary-net">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Net Worth Report -->
    <div id="report-net-worth" class="report-content">
      <div class="metric-cards">
        <div class="metric-card">
          <div class="metric-value positive" id="total-assets">0</div>
          <div class="metric-label">Total Assets</div>
        </div>
        <div class="metric-card">
          <div class="metric-value negative" id="total-liabilities">0</div>
          <div class="metric-label">Total Liabilities</div>
        </div>
        <div class="metric-card">
          <div class="metric-value" id="net-worth-value">0</div>
          <div class="metric-label">Net Worth</div>
        </div>
      </div>

      <div class="report-layout">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Net Worth Breakdown</div>
            <div class="chart-subtitle">Assets vs Liabilities</div>
          </div>
          <canvas id="netWorthChart"></canvas>
        </div>

        <div class="summary-panel">
          <div class="summary-header">Account Details</div>
          <div id="accountBreakdown">
            <div class="loading">
              <div class="spinner"></div>
              Loading accounts...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Spending Trends Report -->
    <div id="report-trends" class="report-content">
      <div class="report-layout">
        <div class="chart-container">
          <div class="chart-header">
            <div class="chart-title">Spending Trends</div>
            <div class="chart-subtitle">Monthly spending over time</div>
          </div>
          <canvas id="trendsChart"></canvas>
        </div>

        <div class="summary-panel">
          <div class="summary-header">Trend Analysis</div>
          <div class="summary-item">
            <div class="summary-label">Avg Monthly</div>
            <div class="summary-value" id="avg-monthly">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Highest Month</div>
            <div class="summary-value" id="highest-month">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Lowest Month</div>
            <div class="summary-value" id="lowest-month">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>

</section>


  <!-- ===== Goals Section ===== -->
  <section id="goals" class="section">

          <div class="header">
            <h1>Financial Goals</h1>
            <button class="add-goal-btn" onclick="openAddGoalModal()">+ Add Goal</button>
        </div>

        <div id="goals-grid" class="goals-grid">
            <!-- Goals will be rendered here -->
        </div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-icon">🎯</div>
            <div class="empty-title">No Goals Yet</div>
            <div class="empty-text">Create your first financial goal to start tracking your progress</div>
            <button class="btn btn-primary" onclick="openAddGoalModal()">Add Your First Goal</button>
        </div>
    </div>

    <!-- Add/Edit Goal Modal -->
    <div id="goal-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" class="modal-title">Add New Goal</h3>
                <button class="close-btn" onclick="closeGoalModal()">&times;</button>
            </div>

            <form id="goal-form">
                <div class="form-group">
                    <label class="form-label">Goal Name</label>
                    <input type="text" id="goal-name" class="form-input" placeholder="e.g., Emergency Fund, Vacation, New Car" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Goal Type</label>
                    <select id="goal-type" class="form-select" required>
                        <option value="">Select goal type</option>
                        <option value="emergency">Emergency Fund</option>
                        <option value="saving">General Savings</option>
                        <option value="vacation">Vacation</option>
                        <option value="purchase">Major Purchase</option>
                        <option value="debt">Debt Payoff</option>
                        <option value="retirement">Retirement</option>
                        <option value="education">Education</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Target Amount ()</label>
                    <input type="number" id="target-amount" class="form-input" min="1" step="0.01" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Target Date</label>
                    <input type="date" id="target-date" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">Monthly Contribution ()</label>
                    <input type="number" id="monthly-contribution" class="form-input" min="0" step="0.01" placeholder="Optional - for automatic calculations">
                </div>

                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="goal-description" class="form-textarea" placeholder="What is this goal for? Any additional details..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Goal</button>
                </div>
            </form>
        </div>
    </div>
  </section>


 
<section id="settings" class="section">
  <header class="settings-header">
    <span>Settings</span>
  </header>

  <div class="settings-container">
    <!-- Sidebar -->
    <nav class="settings-sidebar">
      <ul>
        <li class="active" data-section="profileSection">Profile</li>
        <li data-section="rolloverSection">Rollover Settings</li>
        <li data-section="dataSection">Data Management</li>
      </ul>
    </nav>

    <!-- Content -->
    <div class="settings-content">
      
      <!-- Profile Section -->
      <div class="card settings-section active" id="profileSection">
        <div class="section-header">
          <h2>Profile</h2>
        </div>

        <div class="form-group">
          <label>Name</label>
          <input type="text" id="displayName" placeholder="Your name">
        </div>

        <div class="form-group">
          <label>Email <span class="badge success">Verified</span></label>
          <input type="email" id="email" disabled value="user@example.com">
          <small>Your email address cannot be changed. Contact support if needed.</small>
        </div>

        <div class="form-group">
          <label>Default Currency</label>
          <select id="currency">
        <option>USD</option>
        <option>PHP</option>
        <option>JPY</option>
        <option>EUR</option>
          </select>
          <small>This will be used for all new budgets and transactions.</small>
        </div>

        <button class="btn btn-primary" id="saveBtn">Save Settings</button>
      </div>

      <!-- Rollover Settings Section -->
      <div class="card settings-section" id="rolloverSection" style="display:none;">
        <div class="section-header">
          <h2>Rollover Settings</h2>
        </div>

        <div class="info-box">
          <strong>Budget Rollover:</strong> Control how your budget handles leftover money each month.
        </div>

        <div class="form-group">
          <label>Rollover Mode</label>
          <select id="rolloverMode" onchange="toggleRolloverSettings()">
            <option value="manual">Manual Rollover</option>
            <option value="automatic">Automatic Rollover</option>
          </select>
          <small>Manual: Click button to rollover each month | Automatic: Rollover happens automatically</small>
        </div>

        <div class="form-group" id="automaticDayGroup" style="display: none;">
          <label>Automatic Rollover Day</label>
          <select id="automaticRolloverDay">
            <option value="1">1st of the month</option>
            <option value="2">2nd of the month</option>
            <option value="3">3rd of the month</option>
            <option value="4">4th of the month</option>
            <option value="5">5th of the month</option>
            <option value="10">10th of the month</option>
            <option value="15">15th of the month</option>
            <option value="20">20th of the month</option>
            <option value="25">25th of the month</option>
            <option value="last">Last day of month</option>
          </select>
          <small>Budget will automatically rollover on this day each month</small>
        </div>

        <button class="btn btn-primary" id="saveRolloverBtn">Save Rollover Settings</button>
      </div>

      <!-- Data Management Section -->
      <div class="card settings-section" id="dataSection" style="display:none;">
        <div class="section-header">
          <h2>Data Management</h2>
        </div>

        <div class="form-group">
          <label>Export Data</label>
          <button class="btn btn-secondary" id="exportBtn">Export Backup</button>
          <small>Download a complete backup of all your budget data.</small>
        </div>

        <div class="info-box danger">
          <strong>Danger Zone:</strong> These actions cannot be undone. Please proceed with caution.
        </div>

        <div class="form-group">
          <label>Reset Data <span class="badge danger">Permanent</span></label>
          <button class="btn btn-danger" id="clearDataBtn">Clear All Data</button>
          <small>This will permanently delete all your budgets and transactions.</small>
        </div>

        <div class="form-group">
          <label>Delete Account <span class="badge danger">Final</span></label>
          <button class="btn btn-danger" id="deleteAccountBtn">Delete Account</button>
          <small>Permanently delete your account and all data. This cannot be reversed.</small>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Rollover Confirmation Modal -->
<div id="rolloverModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
  <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
    <h3 style="margin: 0 0 16px 0; color: var(--text, #2d3748);">⚠️ Confirm Rollover</h3>
    <p style="color: var(--text-muted, #718096); margin-bottom: 20px;">
      Are you sure you want to rollover the current month to next month? This action will:
    </p>
    <ul style="color: var(--text-muted, #718096); margin-bottom: 20px; padding-left: 20px;">
      <li>Carry forward positive balances to next month</li>
      <li>Reset negative balances to zero</li>
      <li>Move any negative amounts to "To Be Budgeted"</li>
    </ul>
    <p style="color: var(--text-muted, #718096); margin-bottom: 20px;">
      <strong>This action cannot be undone.</strong>
    </p>
    <div style="display: flex; gap: 12px; justify-content: flex-end;">
      <button class="btn btn-secondary" onclick="closeRolloverModal()">Cancel</button>
      <button class="btn btn-primary" onclick="proceedWithRollover()">Continue</button>
    </div>
  </div>
</div>



  <!-- Footer -->
  <footer>
    © 2025 BudgetMaster ·
    <a href="#">Privacy</a> ·
    <a href="#">Terms</a> ·
    <a href="#">Contact</a>
  </footer>
</div>



  <!-- Modals -->
  <div id="incomeModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('incomeModal')">&times;</span>
      <h2>Add Income</h2>
      <div class="split">
        <div><label>Date</label><input type="date" id="incomeDate"></div>
        <div><label>Amount</label><input type="number" id="incomeAmount" step="0.01"></div>
      </div>
      <label>Description</label>
      <input type="text" id="incomeDescription" placeholder="Salary, Bonus, Gift">
      <div class="modal-actions">
        <button onclick="closeModal('incomeModal')">Cancel</button>
        <button class="btn-primary" onclick="addIncome(); closeModal('incomeModal')">Save</button>
      </div>
    </div>
  </div>

  <div id="categoryModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('categoryModal')">&times;</span>
      <h2>Add Category</h2>
      <div class="split">
        <div><label>Name</label><input type="text" id="categoryName"></div>
        <div><label>Budget</label><input type="number" id="categoryBudget"></div>
      </div>
      <div class="modal-actions">
        <button onclick="closeModal('categoryModal')">Cancel</button>
        <button class="btn-primary" onclick="addCategory(); closeModal('categoryModal')">Save</button>
      </div>
    </div>
  </div>

  <div id="transactionModal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal('transactionModal')">&times;</span>
      <h2>Add Transaction</h2>
      <div class="split">
        <div><label>Payee</label><input type="text" id="transactionName"></div>
        <div><label>Amount</label><input type="number" id="transactionAmount"></div>
      </div>
      <label>Category</label>
      <select id="transactionCategory"></select>
      <label>Date</label>
      <input type="date" id="transactionDate">
      <div class="modal-actions">
        <button onclick="closeModal('transactionModal')">Cancel</button>
        <button class="btn-primary" onclick="addTransaction(); closeModal('transactionModal')">Save</button>
      </div>
    </div>
  </div>


<!-- Password Re-auth Modal -->
<div id="reauthModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Confirm Password</h3>
    <p>Please enter your account password to continue.</p>
    <input type="password" id="reauthPassword" placeholder="Password">
    <div class="modal-actions">
      <button id="reauthCancel" class="btn btn-secondary">Cancel</button>
      <button id="reauthConfirm" class="btn btn-primary">Confirm</button>
    </div>
  </div>
</div>








<script> 
  // ==== Firebase Config ====
  const firebaseConfig = {
    apiKey: "AIzaSyA1txE-ewGSTwVrNk7gVz3z8yLeYTdwYwk",
    authDomain: "budget-monitoringv2.firebaseapp.com",
    projectId: "budget-monitoringv2",
    storageBucket: "budget-monitoringv2.firebasestorage.app",
    messagingSenderId: "539949688092",
    appId: "1:539949688092:web:0655e0318504c6a4e946d9",
    measurementId: "G-M8DLXRV0DW"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const logoutLink = document.querySelector('.logout-link');

  let currentUser = null;
  let accounts = []; // Will hold user accounts
  let editingIndex = null; // Track which account is being edited
  let transactionAccountIndex = null;
  let selectedCategoryIndex = null; // Currently selected category for modal
  let spendingChart, netWorthChart, incomeExpensesChart;
  let goals = [];
  let editingGoalId = null;
  let userSettings = {};
  let userCurrency = "Php";
  let lastRolloverDate = null; // Track last rollover to prevent multiple rollovers in same month





  document.addEventListener("DOMContentLoaded", () => {
    const sidebarLinks = document.querySelectorAll(".sidebar a");
    const sections = document.querySelectorAll(".section");

    // Hide all sections first
    sections.forEach(s => s.style.display = "none");

    // Show Dashboard by default
    const defaultSection = document.querySelector("#dashboard");
    if (defaultSection) defaultSection.style.display = "block";

    sidebarLinks.forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();

        // Remove active class from all links
        sidebarLinks.forEach(l => l.classList.remove("active"));
        link.classList.add("active");

        // Hide all sections
        sections.forEach(s => s.style.display = "none");

        // Show the clicked section
        const targetId = link.getAttribute("href").substring(1); // remove #
        const targetSection = document.getElementById(targetId);
        if (targetSection) targetSection.style.display = "block";
      });
    });
  });








// ==== Render Functions ====
function renderCategories(categories) {
  const div = document.getElementById("categories");
  const select = document.getElementById("transactionCategory");
  div.innerHTML = "";
  select.innerHTML = "";

  categories.forEach((c, index) => {
    // ✅ Always compute fresh balance
    const balance = c.assigned - c.spent;
    const monthLabel = c.month ? `<span class="pill">${c.month}</span>` : "";

    div.innerHTML += `
      <div class="budget-item">
        <div class="item-header">
          <span class="font-bold">${c.name}</span>
          ${monthLabel}
        </div>
        <div class="amounts">
          <div>
            <div class="small">Assigned</div>
            <div>
              <span class="assigned-value" id="assigned-${index}" 
                onclick="editAssigned(${index}, ${c.assigned})">
                ${formatCurrency(c.assigned)}
              </span>
            </div>
          </div>
          <div>
            <div class="small">Spent</div>
            <div>${formatCurrency(c.spent)}</div>
          </div>
          <div>
            <div class="small">Balance</div>
            <div style="color:${balance < 0 ? 'red' : 'green'}">
              ${formatCurrency(balance)}
            </div>
          </div>
        </div>
      </div>
    `;

    select.innerHTML += `<option value="${c.name}">${c.name}</option>`;
  });
}

function formatCurrency(amount, isOutflow = false) {
  if (isNaN(amount)) return "";
  
  const currencySymbols = {
    "USD": "$",
    "PHP": "₱",
    "EUR": "€",
    "JPY": "¥"
  };
  
  const symbol = currencySymbols[userCurrency] || "$";
  
  const formatter = new Intl.NumberFormat("en", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
  
  const formattedAmount = formatter.format(Math.abs(amount));
  
  if (isOutflow) {
    return `-${symbol}${formattedAmount}`;
  }
  
  return `${symbol}${formattedAmount}`;
}

function renderTransactions(transactions) {
  console.log("🔍 Rendering transactions with currency:", userCurrency); // ADD THIS
  const tbody = document.getElementById("transactionsBody");
  tbody.innerHTML = "";

  transactions
    .sort((a, b) => new Date(b.date) - new Date(a.date)) // newest first
    .forEach(t => {
      let outflow = "";
      let inflow = "";

      // Support account-style inflow/outflow
      if (typeof t.outflow === "number" && t.outflow > 0) {
        outflow = formatCurrency(t.outflow, true);
      }
      if (typeof t.inflow === "number" && t.inflow > 0) {
        inflow = formatCurrency(t.inflow, false);
      }

      // Support budget-style transactions (amount + type)
      if (t.type === "expense") {
        outflow = formatCurrency(t.amount, true);
      } else if (t.type === "income") {
        inflow = formatCurrency(t.amount, false);
      } else if (t.type === "transfer") {
        outflow = t.fromAccount ? formatCurrency(t.amount, true) : "";
        inflow = t.toAccount ? formatCurrency(t.amount, false) : "";
      }

      tbody.innerHTML += `
        <tr>
          <td>${t.date ? t.date.slice(0, 10) : ""}</td>
          <td>${t.name || t.payee || ""}</td>
          <td>${t.category || ""}</td>
          <td class="amount-outflow">${outflow}</td>
          <td class="amount-inflow">${inflow}</td>
        </tr>
      `;
    });
}

function renderBudget(data) {
   console.log("🔍 Rendering with currency:", userCurrency); 
  
  if (!data) return;
  const categories = data.categories || [];
  const transactions = data.transactions || [];
  const tbb = data.tbb || 0;

  const assigned = categories.reduce((sum, c) => sum + c.assigned, 0);
  const spent = categories.reduce((sum, c) => sum + c.spent, 0);
  const overspent = categories
    .filter(c => c.spent > c.assigned)
    .reduce((sum, c) => sum + (c.spent - c.assigned), 0);

  document.getElementById("tbb").innerText = formatCurrency(tbb);
  document.getElementById("assigned").innerText = formatCurrency(assigned);
  document.getElementById("spent").innerText = formatCurrency(spent);
  document.getElementById("overspent").innerText = formatCurrency(overspent);

  renderCategories(categories);
  renderTransactions(transactions);
}



  // ==== Edit Assigned ====
  async function editAssigned(index, oldValue) {
    const span = document.getElementById(`assigned-${index}`);
    span.outerHTML = `
      <input type="number" id="assigned-input-${index}" value="${oldValue}" 
        style="width:80px; border:1px solid #ccc; border-radius:4px;" 
        onblur="saveAssigned(${index}, this.value)" 
        onkeydown="if(event.key==='Enter'){this.blur()}">
    `;
    document.getElementById(`assigned-input-${index}`).focus();
  }

 async function saveAssigned(index, newValue) {
  if (!currentUser) return;
  const val = parseFloat(newValue);
  if (isNaN(val) || val < 0) return alert("Enter valid number");

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  const data = docSnap.data() || {};

  // Use the selected month from filter
  const selectedMonth = document.getElementById("monthFilter").value || data.currentMonth || new Date().toISOString().slice(0,7);

  const monthDocRef = docRef.collection("months").doc(selectedMonth);
  const monthSnap = await monthDocRef.get();
  let monthData = monthSnap.exists
    ? monthSnap.data()
    : { categories: JSON.parse(JSON.stringify(data.categories || [])), transactions: [], tbb: data.tbb || 0, currentMonth: selectedMonth };

  if (!monthData.categories[index]) return;

  const oldValue = monthData.categories[index].assigned || 0;
  const diff = val - oldValue;

  // Update assigned & balance
  monthData.categories[index].assigned = val;
  monthData.categories[index].balance = val - monthData.categories[index].spent;

  // Update To Be Budgeted
  monthData.tbb -= diff;

  // Save back to month document
  await monthDocRef.set(monthData);

  // Re-render the filtered month
  renderBudget(monthData);
}


  // ==== Update Budget ====
 async function updateBudget(updates) {
  if (!currentUser) return;

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  const data = docSnap.data() || {};
  const currentMonth = data.currentMonth || new Date().toISOString().slice(0,7);

  const monthDocRef = docRef.collection("months").doc(currentMonth);
  const monthSnap = await monthDocRef.get();
  let monthData = monthSnap.exists ? monthSnap.data() : { ...data, categories: [], transactions: [], currentMonth };

  monthData = { ...monthData, ...updates };
  await monthDocRef.set(monthData);

  renderBudget(monthData);
}

// Load accounts automatically after login
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    await loadAccounts();
  }
}); 
// ==== Auth & Load Data ====
auth.onAuthStateChanged(async (user) => {
  if (!user) return window.location.href = "auth.html";
  currentUser = user;
  
  try {
    const userDoc = await db.collection("users").doc(user.uid).get();
    const userData = userDoc.data();
    
    // ✅ Set global currency from user profile
    if (userDoc.exists && userData?.currency) {
      userCurrency = userData.currency;
      console.log("✅ Currency loaded:", userCurrency); // Debug log
    } else {
      userCurrency = "USD"; // Default fallback
      console.log("⚠️ No currency found, using default: USD");
    }
    
    if (userDoc.exists && userData?.approved === true) {
      document.getElementById("appSection").style.display = "block";
      await loadBudget();
      await loadMonthFilter();
      await loadAccounts();  
    } else {
      alert("Your account is not yet approved.");
      await auth.signOut();
    }
  } catch (err) {
    console.error("Error fetching user:", err);
  }
});


  async function loadBudget() {
  if (!currentUser) return;

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  if (!docSnap.exists) {
    await docRef.set({ tbb: 0, categories: [], transactions: [], currentMonth: new Date().toISOString().slice(0, 7) });
  }

  const data = (await docRef.get()).data();

  const currentMonthKey = data.currentMonth || new Date().toISOString().slice(0, 7);

  // Check if month document exists
  const monthDocRef = docRef.collection("months").doc(currentMonthKey);
  const monthSnap = await monthDocRef.get();

  if (monthSnap.exists) {
    renderBudget(monthSnap.data());
  } else {
    renderBudget(data);
  }
}


 async function addIncome() {
  const amount = parseFloat(document.getElementById("incomeAmount").value);
  const description = document.getElementById("incomeDescription").value.trim();
  const date = document.getElementById("incomeDate").value || new Date().toISOString().slice(0, 10);
  const selectedMonth = document.getElementById("monthFilter").value || null;

  if (isNaN(amount) || amount <= 0) return alert("Enter valid income");

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  const data = docSnap.data();
  const monthsRef = docRef.collection("months");

  // Determine month to use
  const targetMonth = selectedMonth || data.currentMonth || new Date().toISOString().slice(0, 7);

  // Load or create month document
  const monthDocRef = monthsRef.doc(targetMonth);
  const monthSnap = await monthDocRef.get();
  let monthData = monthSnap.exists
    ? monthSnap.data()
    : { categories: JSON.parse(JSON.stringify(data.categories || [])), transactions: [], tbb: data.tbb || 0, currentMonth: targetMonth };

  // Add income transaction
  monthData.transactions.push({
    name: description || "Income",
    amount,
    category: "Income",
    type: "income",
    date
  });

  // Update To Be Budgeted
  monthData.tbb = (monthData.tbb || 0) + amount;

  // Save month data
  await monthDocRef.set(monthData);

  // Re-render the filtered month
  await filterByMonth();

  // Reset modal
  document.getElementById("incomeAmount").value = "";
  document.getElementById("incomeDescription").value = "";
  document.getElementById("incomeDate").value = "";
}

async function addCategory() {
  const name = document.getElementById("categoryName").value.trim();
  const assignAmount = parseFloat(document.getElementById("categoryBudget").value);
  const selectedMonth = document.getElementById("monthFilter").value || null;

  if (!name || isNaN(assignAmount) || assignAmount < 0) return alert("Enter valid category");

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  const data = docSnap.data();
  const monthsRef = docRef.collection("months");

  // Determine month to use
  const targetMonth = selectedMonth || data.currentMonth || new Date().toISOString().slice(0, 7);

  // Load or create month document
  const monthDocRef = monthsRef.doc(targetMonth);
  const monthSnap = await monthDocRef.get();
  let monthData = monthSnap.exists
    ? monthSnap.data()
    : { categories: JSON.parse(JSON.stringify(data.categories || [])), transactions: [], tbb: data.tbb || 0, currentMonth: targetMonth };

  // Prevent duplicates
  if (monthData.categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
    return alert("Category already exists. Please use a different name!");
  }

  // Add new category
  monthData.categories.push({
    name,
    assigned: assignAmount,
    spent: 0,
    balance: assignAmount,
    monthly: { [targetMonth]: { assigned: assignAmount, spent: 0 } }
  });

  // Deduct from To Be Budgeted
  monthData.tbb -= assignAmount;

  // Save month data
  await monthDocRef.set(monthData);

  // Re-render the filtered month
  await filterByMonth();

  // Reset form fields
  document.getElementById("categoryName").value = "";
  document.getElementById("categoryBudget").value = "";
}


async function addTransaction() { 
  const name = document.getElementById("transactionName").value.trim();
  const amount = parseFloat(document.getElementById("transactionAmount").value);
  const category = document.getElementById("transactionCategory").value;
  const selectedMonth = document.getElementById("monthFilter").value || null;

  if (!name || isNaN(amount) || amount <= 0) return alert("Enter valid transaction");

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  const data = docSnap.data();
  const monthsRef = docRef.collection("months");

  // Determine month to use (selected month or currentMonth)
  const targetMonth = selectedMonth || data.currentMonth || new Date().toISOString().slice(0, 7);

  // Load or create month-specific document
  const monthDocRef = monthsRef.doc(targetMonth);
  const monthSnap = await monthDocRef.get();
  let monthData = monthSnap.exists 
    ? monthSnap.data() 
    : {
        categories: JSON.parse(JSON.stringify(data.categories || [])), // deep copy
        transactions: [],
        tbb: data.tbb || 0,
        currentMonth: targetMonth
      };

  // Update category spent for that month
  const catIndex = monthData.categories.findIndex(c => c.name === category);
  if (catIndex !== -1) {
    monthData.categories[catIndex].spent += amount;
    monthData.categories[catIndex].balance = monthData.categories[catIndex].assigned - monthData.categories[catIndex].spent;
  }

  // Add transaction with a unique ID
  const transactionId = Date.now().toString(); // Use the current timestamp as the unique ID
  monthData.transactions.push({
    id: transactionId, // Add ID
    name,
    amount,
    category,
    type: "expense",
    date: new Date().toISOString()
  });

  // Save month data
  await monthDocRef.set(monthData);

  // Re-render the filtered month
  await filterByMonth();

  // Reset modal
  document.getElementById("transactionName").value = "";
  document.getElementById("transactionAmount").value = "";
}




function initiateRollover() {
  const btn = document.getElementById('rolloverBtn');
  const text = btn.querySelector('.btn-text');

  btn.classList.add('loading');
  text.textContent = 'Processing...';

  setTimeout(() => {
    btn.classList.remove('loading');
    btn.classList.add('success');
    text.textContent = 'Rollover Complete';

    setTimeout(() => {
      btn.classList.remove('success');
      text.textContent = 'Rollover';
    }, 4000);
  }, 4000);
}

// Keyboard accessibility
document.getElementById('rolloverBtn').addEventListener('keydown', e => {
  if (e.key === 'Enter' || e.key === ' ') {
    e.preventDefault();
    initiateRollover();
  }
});

// Ripple click effect
document.getElementById('rolloverBtn').addEventListener('click', function (e) {
  const ripple = document.createElement('span');
  const rect = this.getBoundingClientRect();
  const size = Math.max(rect.width, rect.height);
  const x = e.clientX - rect.left - size / 2;
  const y = e.clientY - rect.top - size / 2;

  ripple.style.cssText = `
    position: absolute;
    width: ${size}px;
    height: ${size}px;
    left: ${x}px;
    top: ${y}px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    transform: scale(0);
    animation: ripple 1.2s ease-out forwards;
    pointer-events: none;
    z-index: 0;
  `;

  this.appendChild(ripple);

  setTimeout(() => ripple.remove(), 1200);
});





// Toggle rollover settings visibility
function toggleRolloverSettings() {
  const mode = document.getElementById("rolloverMode").value;
  const automaticDayGroup = document.getElementById("automaticDayGroup");
  const rolloverButton = document.querySelector('button[onclick="initiateRollover()"]');
  
  if (mode === "automatic") {
    automaticDayGroup.style.display = "block";
    if (rolloverButton) {
      rolloverButton.style.display = "none";
    }
  } else {
    automaticDayGroup.style.display = "none";
    if (rolloverButton) {
      rolloverButton.style.display = "inline-block";
    }
  }
}

// Load rollover settings from Firebase
async function loadRolloverSettings() {
  if (!currentUser) return;
  
  try {
    const doc = await firebase.firestore().collection("users").doc(currentUser.uid).get();
    if (doc.exists && doc.data().rolloverSettings) {
      const settings = doc.data().rolloverSettings;
      document.getElementById("rolloverMode").value = settings.mode || "manual";
      if (settings.automaticDay) {
        document.getElementById("automaticRolloverDay").value = settings.automaticDay;
      }
      lastRolloverDate = settings.lastRollover || null;
      toggleRolloverSettings();
    }
  } catch (error) {
    console.error("Error loading rollover settings:", error);
  }
}

// Save rollover settings
document.getElementById("saveRolloverBtn").addEventListener("click", async () => {
  if (!currentUser) return;
  
  const mode = document.getElementById("rolloverMode").value;
  const settings = {
    mode: mode,
    lastRollover: lastRolloverDate
  };
  
  if (mode === "automatic") {
    settings.automaticDay = document.getElementById("automaticRolloverDay").value;
  } else {
    // Remove automatic settings if switching to manual
    settings.automaticDay = null;
  }
  
  try {
    await firebase.firestore().collection("users").doc(currentUser.uid).update({
      rolloverSettings: settings
    });
    
    // Update rollover button visibility in dashboard
    const rolloverButton = document.querySelector('button[onclick="initiateRollover()"]');
    if (rolloverButton) {
      rolloverButton.style.display = mode === "manual" ? "inline-block" : "none";
    }
    
    // If automatic mode, set up automatic rollover check
    if (mode === "automatic") {
      setupAutomaticRollover(settings.automaticDay);
    }
    
    alert("✅ Rollover settings saved!");
  } catch (error) {
    console.error("Error saving rollover settings:", error);
    alert("❌ Failed to save settings. Please try again.");
  }
});

// Initiate manual rollover (called from dashboard button)
function initiateRollover() {
  // Check if already rolled over this month
  if (lastRolloverDate) {
    const lastRollover = new Date(lastRolloverDate);
    const now = new Date();
    if (lastRollover.getFullYear() === now.getFullYear() && 
        lastRollover.getMonth() === now.getMonth()) {
      alert("⚠️ You have already performed a rollover this month. Rollover is only available once per month.");
      return;
    }
  }
  
  // Show confirmation modal
  document.getElementById("rolloverModal").style.display = "flex";
}

// Close rollover modal
function closeRolloverModal() {
  document.getElementById("rolloverModal").style.display = "none";
}

// Proceed with rollover after confirmation
async function proceedWithRollover() {
  closeRolloverModal();
  
  // Request reauthentication
  const authenticated = await reauthenticateUserModal();
  if (!authenticated) return;
  
  // Perform rollover
  await performRollover();
}

// Updated rollover function with tracking
async function performRollover() {
  if (!currentUser) return;

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  if (!docSnap.exists) return;

  const data = docSnap.data();
  const baseMonthKey = data.currentMonth || new Date().toISOString().slice(0,7);

  // Load current month doc
  const currentMonthDocRef = docRef.collection("months").doc(baseMonthKey);
  const currentMonthSnap = await currentMonthDocRef.get();
  if (!currentMonthSnap.exists) return alert("Current month data not found!");

  const currentMonthData = currentMonthSnap.data();
  const categories = currentMonthData.categories || [];
  let carryOverTBB = currentMonthData.tbb || 0;

  // Save current month data
  await currentMonthDocRef.set({ ...currentMonthData, savedAt: new Date().toISOString() });

  // Prepare next month categories
  const newCategories = categories.map(c => {
    const balance = c.assigned - c.spent;
    if (balance >= 0) return { name: c.name, assigned: balance, spent: 0, balance };
    carryOverTBB += balance; // negative balance adds back to TBB
    return { name: c.name, assigned: 0, spent: 0, balance: 0 };
  });

  // Compute next month key
  const [year, month] = baseMonthKey.split("-").map(Number);
  const nextMonthDate = new Date(year, month - 1, 1);
  nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
  const nextMonthKey = `${nextMonthDate.getFullYear()}-${String(nextMonthDate.getMonth() + 1).padStart(2, "0")}`;

  // Create next month doc
  const nextMonthDocRef = docRef.collection("months").doc(nextMonthKey);
  await nextMonthDocRef.set({
    categories: newCategories,
    transactions: [],
    tbb: carryOverTBB,
    currentMonth: nextMonthKey
  });

  // Update main doc pointer
  await docRef.update({ currentMonth: nextMonthKey });
  
  // Update last rollover date
  lastRolloverDate = new Date().toISOString();
  await firebase.firestore().collection("users").doc(currentUser.uid).update({
    "rolloverSettings.lastRollover": lastRolloverDate
  });

  // Reload month filter and render
  await loadMonthFilter();
  document.getElementById("monthFilter").value = ""; // reset to current month view
  await filterByMonth();

  alert(`✅ Rollover complete! Balances carried forward to ${nextMonthKey}.`);
}

// Setup automatic rollover checking
function setupAutomaticRollover(rolloverDay) {
  // This function would be called periodically to check if automatic rollover should occur
  // You would typically call this on app load and set up a daily check
  
  setInterval(async () => {
    await checkAndPerformAutomaticRollover(rolloverDay);
  }, 86400000); // Check once per day
  
  // Also check immediately on setup
  checkAndPerformAutomaticRollover(rolloverDay);
}

// Check and perform automatic rollover if needed
async function checkAndPerformAutomaticRollover(rolloverDay) {
  if (!currentUser) return;
  
  const now = new Date();
  const currentDay = now.getDate();
  const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  
  let shouldRollover = false;
  
  if (rolloverDay === "last") {
    shouldRollover = currentDay === lastDayOfMonth;
  } else {
    const targetDay = parseInt(rolloverDay);
    shouldRollover = currentDay === targetDay;
  }
  
  if (!shouldRollover) return;
  
  // Check if already rolled over this month
  if (lastRolloverDate) {
    const lastRollover = new Date(lastRolloverDate);
    if (lastRollover.getFullYear() === now.getFullYear() && 
        lastRollover.getMonth() === now.getMonth()) {
      return; // Already rolled over this month
    }
  }
  
  // Perform automatic rollover
  await performRollover();
}

// ✅ Load ALL months into filter (dynamic, works with rollover)
async function loadMonthFilter() {
  if (!currentUser) return;

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  if (!docSnap.exists) return;

  const currentMonthKey =
    docSnap.data().currentMonth || new Date().toISOString().slice(0, 7);

  const monthsRef = docRef.collection("months");
  const snapshot = await monthsRef.get();

  const monthSelect = document.getElementById("monthFilter");
  monthSelect.innerHTML = "";

  if (snapshot.empty) {
    // fallback: just current month
    monthSelect.innerHTML = `<option value="${currentMonthKey}">${currentMonthKey}</option>`;
    return;
  }

  // Collect and sort all months
  const allMonths = snapshot.docs.map(doc => doc.id).sort();

  allMonths.forEach(m => {
    const label = m === currentMonthKey ? `Current Month (${m})` : m;
    monthSelect.innerHTML += `<option value="${m}">${label}</option>`;
  });

  // Set selected value
  monthSelect.value = currentMonthKey;
}

// ✅ Filter by month, update dashboard + budget section
async function filterByMonth() {
  if (!currentUser) return;

  const selectedMonth = document.getElementById("monthFilter").value;
  const docRef = db.collection("budget").doc(currentUser.uid);

  if (!selectedMonth) {
    // fallback to default loaders
    await loadBudget();        // dashboard summary
    await loadBudgetSection(); // budget table
    return;
  }

  // Update root doc so "currentMonth" stays in sync
  await docRef.update({ currentMonth: selectedMonth });

  const monthRef = docRef.collection("months").doc(selectedMonth);
  const monthSnap = await monthRef.get();

  let monthData;
  if (monthSnap.exists) {
    monthData = monthSnap.data();
  } else {
    // create empty doc if missing
    monthData = {
      categories: [],
      transactions: [],
      tbb: 0,
      currentMonth: selectedMonth,
    };
    await monthRef.set(monthData);
  }

  // reset category selection
  selectedCategoryIndex = null;

  // ✅ Update BOTH sections
  renderBudget(monthData); // dashboard summary
  renderBudgetSection(monthData.categories, monthData.transactions); // budget table
}



////////ACCOUNT SECTION

// Render accounts
function renderAccounts(list) {
  const div = document.getElementById("accounts-list");
  div.innerHTML = "";

  if (!list || list.length === 0) {
    div.innerHTML = "<p>No accounts yet.</p>";
    return;
  }

  list.forEach((acc, index) => {
    div.innerHTML += `
      <div class="account-item">
        <div>
          <strong>${acc.name}</strong>
          <p class="sub">${formatCurrency(acc.balance)}</p>
        </div>
        <div class="account-actions">
          <button class="btn btn-sm btn-outline" onclick="openTransactionModal(${index})">+ Transaction</button>
          <button class="btn btn-sm btn-danger" onclick="deleteAccount(${index})">Delete</button>
        </div>
      </div>
    `;
  });
}


function formatCurrency(amount, isOutflow = false) {
  if (isNaN(amount)) return "";
  
  const currencySymbols = {
    "USD": "$",
    "PHP": "₱",
    "EUR": "€",
    "JPY": "¥"
  };
  
  const symbol = currencySymbols[userCurrency] || "$";
  
  const formatter = new Intl.NumberFormat("en", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
  
  const formattedAmount = formatter.format(Math.abs(amount));
  
  if (isOutflow) {
    return `-${symbol}${formattedAmount}`;
  }
  
  return `${symbol}${formattedAmount}`;
}



// Load accounts from Firestore
async function loadAccounts() {
  if (!currentUser) return;

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  const data = docSnap.exists ? docSnap.data() : null;

  accounts = data?.accounts || [];
  renderAccounts(accounts);
}

// Open modal for Add or Edit
document.getElementById("add-account-btn").addEventListener("click", () => {
  editingIndex = null;
  document.getElementById("account-modal-title").innerText = "Add Account";
  document.getElementById("account-name").value = "";
  document.getElementById("account-balance").value = "";
  openModal("account-modal");
});

// Save account (add or edit)
document.getElementById("save-account-btn").addEventListener("click", async () => {
  const name = document.getElementById("account-name").value.trim();
  const balance = parseFloat(document.getElementById("account-balance").value);
  if (!name) return alert("Enter an account name");
  if (isNaN(balance)) return alert("Enter a valid balance");
  if (!currentUser) return;

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  let data = docSnap.exists ? docSnap.data() : { accounts: [], tbb: 0, categories: [], transactions: [], currentMonth: new Date().toISOString().slice(0,7) };

  // Prevent duplicate names
  if (editingIndex === null && data.accounts?.some(a => a.name.toLowerCase() === name.toLowerCase())) {
    return alert("Account already exists!");
  }

  if (editingIndex !== null) {
    // Update existing account (name + balance only)
    data.accounts[editingIndex].name = name;
    data.accounts[editingIndex].balance = balance;
    // 🚫 Do NOT touch TBB
  } else {
    // Add new account
    data.accounts = data.accounts || [];
    data.accounts.push({ name, balance });
    // 🚫 Do NOT touch TBB
  }

  await docRef.set(data);
  accounts = data.accounts;
  renderAccounts(accounts);

  // Render budget with latest data
  const currentMonth = data.currentMonth || new Date().toISOString().slice(0,7);
  const monthDocRef = docRef.collection("months").doc(currentMonth);
  const monthSnap = await monthDocRef.get();
  const monthData = monthSnap.exists ? monthSnap.data() : { categories: data.categories || [], transactions: [], tbb: 0, currentMonth };

  renderBudget(monthData);

  closeModal("account-modal");
});


// Delete account
async function deleteAccount(index) {
  if (!confirm(`Delete account "${accounts[index].name}"?`)) return;
  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  let data = docSnap.exists ? docSnap.data() : null;
  if (!data) return;

  // 🚫 Do NOT remove balance from TBB
  data.accounts.splice(index, 1);

  await docRef.set(data);
  accounts = data.accounts;
  renderAccounts(accounts);

  // Keep budget data intact
  const currentMonth = data.currentMonth || new Date().toISOString().slice(0,7);
  const monthDocRef = docRef.collection("months").doc(currentMonth);
  const monthSnap = await monthDocRef.get();
  const monthData = monthSnap.exists ? monthSnap.data() : { categories: data.categories || [], transactions: [], tbb: 0, currentMonth };

  renderBudget(monthData);
}


/////// TRANSACTIONS ////////

// Open Transaction Modal
function openTransactionModal(index) {
  transactionAccountIndex = index;
  document.getElementById("transaction-type").value = "deposit";
  document.getElementById("transaction-amount").value = "";
  document.getElementById("transfer-target-group").style.display = "none";

  // Populate transfer target dropdown
  const targetSelect = document.getElementById("transfer-target");
  targetSelect.innerHTML = "";
  accounts.forEach((acc, i) => {
    if (i !== index) {
      targetSelect.innerHTML += `<option value="${i}">${acc.name}</option>`;
    }
  });

  openModal("transaction-modal");
}

// Show/hide transfer target field
document.getElementById("transaction-type").addEventListener("change", (e) => {
  document.getElementById("transfer-target-group").style.display =
    e.target.value === "transfer" ? "block" : "none";
});

document.getElementById("save-transaction-btn").addEventListener("click", async () => {
  const type = document.getElementById("transaction-type").value;
  const amount = parseFloat(document.getElementById("transaction-amount").value);
  const date = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

  if (isNaN(amount) || amount <= 0) return alert("Enter a valid amount");

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  let data = docSnap.exists ? docSnap.data() : null;
  if (!data) return;

  data.transactions = data.transactions || [];

  let newTransaction = {
    date,
    name: data.accounts[transactionAccountIndex].name,
    category: type === "deposit" ? "Deposit" : type === "withdrawal" ? "Withdrawal" : "Transfer",
    amount,
    type,
    inflow: 0,
    outflow: 0,
    fromAccount: null,
    toAccount: null
  };

  if (type === "deposit") {
    data.accounts[transactionAccountIndex].balance += amount;
    data.tbb += amount;
    newTransaction.inflow = amount;

  } else if (type === "withdrawal") {
    if (data.accounts[transactionAccountIndex].balance < amount) return alert("Insufficient balance");

    data.accounts[transactionAccountIndex].balance -= amount;
    newTransaction.outflow = amount; // Correctly mark as outflow
    // ✅ Do NOT add to budget inflow
  } else if (type === "transfer") {
    const targetIndex = parseInt(document.getElementById("transfer-target").value);
    if (data.accounts[transactionAccountIndex].balance < amount) return alert("Insufficient balance");

    data.accounts[transactionAccountIndex].balance -= amount;
    data.accounts[targetIndex].balance += amount;

    newTransaction.outflow = amount;
    newTransaction.inflow = amount;
    newTransaction.fromAccount = data.accounts[transactionAccountIndex].name;
    newTransaction.toAccount = data.accounts[targetIndex].name;
  }

  data.transactions.push(newTransaction);
  await docRef.set(data);

  // Save to current month
  const currentMonth = data.currentMonth || new Date().toISOString().slice(0, 7);
  const monthDocRef = docRef.collection("months").doc(currentMonth);
  const monthSnap = await monthDocRef.get();
  let monthData = monthSnap.exists
    ? monthSnap.data()
    : { categories: JSON.parse(JSON.stringify(data.categories || [])), transactions: [], tbb: data.tbb, currentMonth };

  monthData.transactions.push(newTransaction);
  await monthDocRef.set(monthData);

  accounts = data.accounts;
  renderAccounts(accounts);
  renderBudget(monthData);
  renderTransactions(monthData.transactions);

  closeModal("transaction-modal");
});



// Load accounts automatically after login
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    await loadAccounts();
  }
});


///// BUDGET SECTION - Google-style with Modal //////
function renderBudgetSection(categories, transactions) {
  const tbody = document.getElementById("budget-table-body");
  tbody.innerHTML = ""; // Clear previous rows

  categories.forEach((c, index) => {
    const balance = c.assigned - c.spent;

    const row = document.createElement("tr");

    row.innerHTML = `
      <td><input type="checkbox" class="category-checkbox" data-index="${index}" /></td>
      <td>${c.name}</td>
      <td>${formatCurrency(c.assigned)}</td>
      <td>${formatCurrency(c.spent)}</td>
      <td style="color:${balance<0?'red':'green'}">${formatCurrency(balance)}</td>
    `;

    tbody.appendChild(row);
  });

  // Add checkbox click listeners
  document.querySelectorAll(".category-checkbox").forEach(cb => {
    cb.checked = false;
    cb.addEventListener("change", async (e) => {
      if (!e.target.checked) return;
      const idx = parseInt(e.target.dataset.index);
      selectedCategoryIndex = idx;
      await openCategoryModal(categories[idx], transactions);
      e.target.checked = false;
    });
  });
}


async function loadBudgetSection() {
  if (!currentUser) return;

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();

  // ✅ If root doc doesn't exist, initialize
  if (!docSnap.exists) {
    const initData = { 
      tbb: 0, 
      categories: [], 
      transactions: [], 
      currentMonth: new Date().toISOString().slice(0, 7) 
    };
    await docRef.set(initData);
  }

  const data = (await docRef.get()).data();
  // ✅ Respect selected filter (like filterByMonth)
  const selectedMonth = document.getElementById("monthFilter")?.value;
  const targetMonth = selectedMonth || data.currentMonth || new Date().toISOString().slice(0, 7);

  const monthRef = docRef.collection("months").doc(targetMonth);
  const monthSnap = await monthRef.get();

  let monthData;
  if (monthSnap.exists) {
    monthData = monthSnap.data();
  } else {
    // ✅ If month doc doesn’t exist, clone root categories
    monthData = {
      categories: JSON.parse(JSON.stringify(data.categories || [])),
      transactions: [],
      tbb: data.tbb || 0,
      currentMonth: targetMonth,
    };
    await monthRef.set(monthData);
  }

  // Reset selection on reload
  selectedCategoryIndex = null;

  renderBudgetSection(monthData.categories, monthData.transactions);
}







// Format the date in a more readable format (e.g., "Sep 10, 2025")
function formatDate(date) {
  const options = { year: 'numeric', month: 'short', day: 'numeric' };
  return new Date(date).toLocaleDateString('en-US', options);
}


function formatCurrency(amount, isOutflow = false) {
  if (isNaN(amount)) return "";
  
  const currencySymbols = {
    "USD": "$",
    "PHP": "₱",
    "EUR": "€",
    "JPY": "¥"
  };
  
  const symbol = currencySymbols[userCurrency] || "$";
  
  const formatter = new Intl.NumberFormat("en", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
  
  const formattedAmount = formatter.format(Math.abs(amount));
  
  if (isOutflow) {
    return `-${symbol}${formattedAmount}`;
  }
  
  return `${symbol}${formattedAmount}`;
}



// Open category modal and render transactions in YNAB style
async function openCategoryModal(category, transactions) {
  document.getElementById("category-name-input").value = category.name;

  const txList = document.getElementById("category-transactions-list");
  txList.innerHTML = ""; // Clear previous transactions

  transactions
    .filter(t => t.category === category.name)
    .forEach((t) => {
      const li = document.createElement("li");
      li.className = "transaction-item";

      // Determine the sign for transaction amounts (outflow = negative, inflow = positive)
      const amountClass = t.type === "expense" ? "outflow" : "inflow";
      const sign = t.type === "expense" ? "-" : "+";
   
      const formattedAmount = `${sign}₱${Math.abs(t.amount).toLocaleString(undefined, {

        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      })}`;

      li.innerHTML = `
        <div class="tx-left">
          <span class="tx-date">${formatDate(t.date)}</span>
          <span class="tx-type">${t.type.charAt(0).toUpperCase() + t.type.slice(1)}</span> <!-- Capitalize type -->
        </div>
        <div class="tx-right">
          <span class="tx-amount ${amountClass}">${formattedAmount}</span>
          <button class="delete-tx-btn" data-id="${t.id}">✖</button>
        </div>
      `;

      txList.appendChild(li);
    });

  // Attach delete handlers
  document.querySelectorAll(".delete-tx-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const txId = e.target.dataset.id;
      await deleteTransaction(category.name, txId);
    });
  });

  openModal("category-modal");
}

// ✅ Delete transaction (and return amount to category)
async function deleteTransaction(categoryName, txId) {
  if (!confirm("Delete this transaction?")) return;

  if (!currentUser) return;
  const docRef = db.collection("budget").doc(currentUser.uid);
  const selectedMonth = document.getElementById("monthFilter")?.value || new Date().toISOString().slice(0, 7);
  const monthRef = docRef.collection("months").doc(selectedMonth);
  const monthSnap = await monthRef.get();
  if (!monthSnap.exists) return showToast("Month data not found", "error");

  let monthData = monthSnap.data();

  const txIndex = monthData.transactions.findIndex((t) => t.id === txId);
  if (txIndex === -1) return;

  const tx = monthData.transactions[txIndex];

  // ✅ Adjust category values
  const cat = monthData.categories.find((c) => c.name === categoryName);
  if (cat) {
    if (tx.type === "outflow") {
      // return money back
      cat.spent -= tx.amount;
      if (cat.spent < 0) cat.spent = 0;
    } else if (tx.type === "inflow") {
      // rollback inflow
      cat.assigned -= tx.amount;
      if (cat.assigned < 0) cat.assigned = 0;
    }
  }

  // ✅ Remove transaction
  monthData.transactions.splice(txIndex, 1);

  await monthRef.set(monthData);

  // Reload UI
  closeModal("category-modal");
  await loadBudgetSection();
  showToast("Transaction deleted and budget adjusted", "success");
}

// ✅ Save edited category
document.getElementById("save-category-btn").addEventListener("click", async () => {
  if (selectedCategoryIndex === null) return;

  const newName = document.getElementById("category-name-input").value.trim();
  if (!newName) return showToast("Enter a category name", "error");

  if (!currentUser) return;

  const docRef = db.collection("budget").doc(currentUser.uid);
  const selectedMonth = document.getElementById("monthFilter")?.value || new Date().toISOString().slice(0, 7);

  const monthRef = docRef.collection("months").doc(selectedMonth);
  const monthSnap = await monthRef.get();
  if (!monthSnap.exists) return showToast("Month data not found", "error");

  let monthData = monthSnap.data();
  if (!monthData.categories[selectedCategoryIndex]) return showToast("Category not found", "error");

  const oldName = monthData.categories[selectedCategoryIndex].name;
  monthData.categories[selectedCategoryIndex].name = newName;

  // ✅ Update transactions with new name
  monthData.transactions = monthData.transactions.map(t =>
    t.category === oldName ? { ...t, category: newName } : t
  );

  await monthRef.set(monthData);

  closeModal("category-modal");
  await loadBudgetSection();

  showToast(`Category renamed from "${oldName}" to "${newName}"`, "success");
});

// ✅ Delete category
document.getElementById("delete-category-btn").addEventListener("click", async () => {
  if (!confirm("Delete this category?")) return;

  const docRef = db.collection("budget").doc(currentUser.uid);
  const docSnap = await docRef.get();
  let data = docSnap.exists ? docSnap.data() : null;
  if (!data) return;

  const currentMonth = data.currentMonth || new Date().toISOString().slice(0, 7);
  const monthRef = docRef.collection("months").doc(currentMonth);
  const monthSnap = await monthRef.get();
  let monthData = monthSnap.exists ? monthSnap.data() : { categories: [], transactions: [], tbb: data.tbb };

  if (selectedCategoryIndex == null || !monthData.categories[selectedCategoryIndex]) return;

  const cat = monthData.categories[selectedCategoryIndex];
  const catName = cat.name;

  // ✅ Return assigned to TBB
  monthData.tbb += (cat.assigned || 0);

  // ✅ Remove category
  monthData.categories.splice(selectedCategoryIndex, 1);

  // ✅ Remove related transactions
  monthData.transactions = monthData.transactions.filter(t => t.category !== catName);

  await monthRef.set(monthData);

  closeModal("category-modal");
  await loadBudgetSection();

  showToast(`Category "${catName}" deleted successfully`, "success");
});

// ✅ Delete transaction (and return amount to category)
async function deleteTransaction(categoryName, txId) {
  if (!confirm("Delete this transaction?")) return;

  if (!currentUser) return;
  const docRef = db.collection("budget").doc(currentUser.uid);
  const selectedMonth = document.getElementById("monthFilter")?.value || new Date().toISOString().slice(0, 7);
  const monthRef = docRef.collection("months").doc(selectedMonth);
  const monthSnap = await monthRef.get();
  if (!monthSnap.exists) return showToast("Month data not found", "error");

  let monthData = monthSnap.data();

  const txIndex = monthData.transactions.findIndex((t) => t.id === txId);
  if (txIndex === -1) return alert("Transaction not found!");

  const tx = monthData.transactions[txIndex];

  // ✅ Adjust category values
  const cat = monthData.categories.find((c) => c.name === categoryName);
  if (cat) {
    if (tx.type === "expense") {
      // return money back
      cat.spent -= tx.amount;
      if (cat.spent < 0) cat.spent = 0;
    } else if (tx.type === "income") {
      // rollback income
      cat.assigned -= tx.amount;
      if (cat.assigned < 0) cat.assigned = 0;
    }
  }

  // ✅ Remove transaction
  monthData.transactions.splice(txIndex, 1);

  await monthRef.set(monthData);

  // Reload the updated data for budget, categories, and transactions
  await loadBudgetSection(); // Make sure this function reloads all necessary data

  // Re-render the updated budget and categories
  renderBudget(monthData);

  // ✅ Close the modal after deletion
  closeModal("category-modal");  // Close the category modal (replace 'category-modal' with the actual modal ID if different)

  showToast("Transaction deleted and budget adjusted", "success");
}








function showToast(message, type = "success") {
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;

  container.appendChild(toast);

  // Animate in
  setTimeout(() => toast.classList.add("show"), 50);

  // Auto remove after 3s
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Automatically load budget section after login
auth.onAuthStateChanged(async (user) => {
  if (!user) return window.location.href = "auth.html";
  currentUser = user;

  await loadBudgetSection();
});




// ===== Reports Section =====

    // YNAB Color Palette
    const ynabColors = [
      '#005a9c', '#16a085', '#e74c3c', '#f39c12', 
      '#9b59b6', '#f1c40f', '#1abc9c', '#e91e63', 
      '#3f51b5', '#95a5a6', '#34495e', '#2ecc71'
    ];

    // Chart instances
    let charts = {
      spending: null,
      incomeExpense: null,
      netWorth: null,
      trends: null
    };

    // Global data
    let budgetData = null;
    let currentDateRange = 'current-month';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        loadData();
      } else {
        window.location.href = 'auth.html';
      }
    });

    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.report-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          switchTab(this.dataset.report);
        });
      });

      // Date range selection
      document.getElementById('dateRange').addEventListener('change', function() {
        const customRangeElements = document.querySelectorAll('[id^="customDateRange"]');
        if (this.value === 'custom') {
          customRangeElements.forEach(el => el.style.display = 'block');
        } else {
          customRangeElements.forEach(el => el.style.display = 'none');
        }
        currentDateRange = this.value;
      });
    }

    function switchTab(reportType) {
      // Update tab active state
      document.querySelectorAll('.report-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-report="${reportType}"]`).classList.add('active');

      // Update content active state
      document.querySelectorAll('.report-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`report-${reportType}`).classList.add('active');

      // Load specific report data
      if (budgetData) {
        switch(reportType) {
          case 'spending':
            loadSpendingReport();
            break;
          case 'income-expense':
            loadIncomeExpenseReport();
            break;
          case 'net-worth':
            loadNetWorthReport();
            break;
          case 'trends':
            loadTrendsReport();
            break;
        }
      }
    }

    async function loadData() {
      const user = auth.currentUser;
      if (!user) return;

      try {
        const budgetRef = db.collection("budget").doc(user.uid);
        const budgetSnap = await budgetRef.get();
        
        if (!budgetSnap.exists) {
          console.log('No budget data found');
          return;
        }

        budgetData = budgetSnap.data();
        
        // Load months data
        const monthsRef = budgetRef.collection("months");
        const monthsSnap = await monthsRef.get();
        
        budgetData.months = {};
        monthsSnap.forEach(doc => {
          budgetData.months[doc.id] = doc.data();
        });

        // Load initial reports
        loadAllReports();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function loadAllReports() {
      loadSpendingReport();
      loadIncomeExpenseReport();
      loadNetWorthReport();
      loadTrendsReport();
    }

    function getDateRange() {
      const now = new Date();
      let startDate, endDate;

      switch(currentDateRange) {
        case 'current-month':
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          break;
        case 'last-month':
          startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          endDate = new Date(now.getFullYear(), now.getMonth(), 0);
          break;
        case 'last-3-months':
          startDate = new Date(now.getFullYear(), now.getMonth() - 3, 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          break;
        case 'last-6-months':
          startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          break;
        case 'current-year':
          startDate = new Date(now.getFullYear(), 0, 1);
          endDate = new Date(now.getFullYear(), 11, 31);
          break;
        case 'custom':
          const fromDate = document.getElementById('fromDate').value;
          const toDate = document.getElementById('toDate').value;
          if (fromDate && toDate) {
            startDate = new Date(fromDate);
            endDate = new Date(toDate);
          } else {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          }
          break;
        default:
          startDate = new Date(now.getFullYear(), now.getMonth(), 1);
          endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      }

      return { startDate, endDate };
    }

    function getFilteredTransactions() {
      if (!budgetData || !budgetData.months) return [];
      
      const { startDate, endDate } = getDateRange();
      let allTransactions = [];

      Object.values(budgetData.months).forEach(monthData => {
        if (monthData.transactions) {
          monthData.transactions.forEach(transaction => {
            const transactionDate = new Date(transaction.date);
            if (transactionDate >= startDate && transactionDate <= endDate) {
              allTransactions.push(transaction);
            }
          });
        }
      });

      return allTransactions;
    }

    function loadSpendingReport() {
      const transactions = getFilteredTransactions();
      const expenses = transactions.filter(t => t.type === 'expense');
      
      // Calculate totals by category
      const categoryTotals = {};
      let totalSpending = 0;

      expenses.forEach(transaction => {
        const category = transaction.category || 'Uncategorized';
        categoryTotals[category] = (categoryTotals[category] || 0) + transaction.amount;
        totalSpending += transaction.amount;
      });

      // Update metrics
      const { startDate, endDate } = getDateRange();
      const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
      const dailyAverage = totalSpending / days;

      document.getElementById('total-spending').textContent = formatCurrency(totalSpending);
      document.getElementById('avg-daily-spending').textContent = formatCurrency(dailyAverage);

      const topCategory = Object.keys(categoryTotals).reduce((a, b) => 
        categoryTotals[a] > categoryTotals[b] ? a : b, 'None'
      );
      document.getElementById('top-category-spending').textContent = 
        topCategory !== 'None' ? formatCurrency(categoryTotals[topCategory]) : '₱0';

      // Create chart
      const categories = Object.keys(categoryTotals);
      const amounts = Object.values(categoryTotals);

      if (charts.spending) {
        charts.spending.destroy();
      }

      const ctx = document.getElementById('spendingChart').getContext('2d');
      charts.spending = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: categories,
          datasets: [{
            data: amounts,
            backgroundColor: ynabColors.slice(0, categories.length),
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#2c3e50',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#34495e',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  const percentage = ((context.raw / totalSpending) * 100).toFixed(1);
                  return `${context.label}: ${formatCurrency(context.raw)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Update breakdown list
      const breakdownList = document.getElementById('spendingBreakdown');
      if (categories.length === 0) {
        breakdownList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">📊</div>
            <p>No spending data available for the selected period.</p>
          </div>
        `;
      } else {
        const sortedCategories = categories
          .map((cat, index) => ({ name: cat, amount: amounts[index], color: ynabColors[index] }))
          .sort((a, b) => b.amount - a.amount);

        breakdownList.innerHTML = sortedCategories.map(item => `
          <div class="breakdown-item">
            <div class="breakdown-category">
              <div class="category-color" style="background-color: ${item.color}"></div>
              <div class="category-name">${item.name}</div>
            </div>
            <div class="category-amount">${formatCurrency(item.amount)}</div>
          </div>
        `).join('');
      }
    }

    function loadIncomeExpenseReport() {
      const transactions = getFilteredTransactions();
      const income = transactions.filter(t => t.type === 'income');
      const expenses = transactions.filter(t => t.type === 'expense');

      const totalIncome = income.reduce((sum, t) => sum + t.amount, 0);
      const totalExpenses = expenses.reduce((sum, t) => sum + t.amount, 0);
      const netIncome = totalIncome - totalExpenses;

      // Update metrics
      document.getElementById('total-income').textContent = formatCurrency(totalIncome);
      document.getElementById('total-expenses').textContent = formatCurrency(totalExpenses);
      document.getElementById('net-income').textContent = formatCurrency(netIncome);
      document.getElementById('net-income').className = `metric-value ${netIncome >= 0 ? 'positive' : 'negative'}`;

      // Update summary
      document.getElementById('summary-income').textContent = formatCurrency(totalIncome);
      document.getElementById('summary-expenses').textContent = formatCurrency(totalExpenses);
      document.getElementById('summary-net').textContent = formatCurrency(netIncome);
      document.getElementById('summary-net').className = `summary-value ${netIncome >= 0 ? 'positive' : 'negative'}`;

      // Create monthly comparison chart
      const monthlyData = getMonthlyIncomeExpense();
      
      if (charts.incomeExpense) {
        charts.incomeExpense.destroy();
      }

      const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
      charts.incomeExpense = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: monthlyData.labels,
          datasets: [{
            label: 'Income',
            data: monthlyData.income,
            backgroundColor: '#16a085',
            borderRadius: 4,
            borderSkipped: false
          }, {
            label: 'Expenses',
            data: monthlyData.expenses,
            backgroundColor: '#e74c3c',
            borderRadius: 4,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: '#2c3e50',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#34495e',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: '#e5e5e5'
              },
              ticks: {
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            }
          }
        }
      });
    }

    function loadNetWorthReport() {
      const accounts = budgetData.accounts || [];
      
      let totalAssets = 0;
      let totalLiabilities = 0;
      let accountBreakdown = [];

      accounts.forEach(account => {
        if (account.balance >= 0) {
          totalAssets += account.balance;
        } else {
          totalLiabilities += Math.abs(account.balance);
        }
        
        accountBreakdown.push({
          name: account.name,
          balance: account.balance,
          type: account.balance >= 0 ? 'asset' : 'liability'
        });
      });

      const netWorth = totalAssets - totalLiabilities;

      // Update metrics
      document.getElementById('total-assets').textContent = formatCurrency(totalAssets);
      document.getElementById('total-liabilities').textContent = formatCurrency(totalLiabilities);
      document.getElementById('net-worth-value').textContent = formatCurrency(netWorth);
      document.getElementById('net-worth-value').className = `metric-value ${netWorth >= 0 ? 'positive' : 'negative'}`;

      // Create chart
      if (charts.netWorth) {
        charts.netWorth.destroy();
      }

      const ctx = document.getElementById('netWorthChart').getContext('2d');
      charts.netWorth = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Assets', 'Liabilities'],
          datasets: [{
            data: [totalAssets, totalLiabilities],
            backgroundColor: ['#16a085', '#e74c3c'],
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: '#2c3e50',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#34495e',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  const percentage = ((context.raw / (totalAssets + totalLiabilities)) * 100).toFixed(1);
                  return `${context.label}: ${formatCurrency(context.raw)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });

      // Update account breakdown
      const accountBreakdownElement = document.getElementById('accountBreakdown');
      if (accountBreakdown.length === 0) {
        accountBreakdownElement.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">🏦</div>
            <p>No account data available.</p>
          </div>
        `;
      } else {
        accountBreakdown.sort((a, b) => Math.abs(b.balance) - Math.abs(a.balance));
        accountBreakdownElement.innerHTML = accountBreakdown.map(account => `
          <div class="summary-item">
            <div class="summary-label">${account.name}</div>
            <div class="summary-value ${account.type === 'asset' ? 'positive' : 'negative'}">
              ${formatCurrency(Math.abs(account.balance))}
            </div>
          </div>
        `).join('');
      }
    }

    function loadTrendsReport() {
      const monthlySpending = getMonthlySpending();
      
      if (charts.trends) {
        charts.trends.destroy();
      }

      // Calculate trend metrics
      const amounts = monthlySpending.amounts;
      const avgMonthly = amounts.reduce((a, b) => a + b, 0) / amounts.length || 0;
      const highestMonth = Math.max(...amounts) || 0;
      const lowestMonth = Math.min(...amounts) || 0;

      // Update metrics
      document.getElementById('avg-monthly').textContent = formatCurrency(avgMonthly);
      document.getElementById('highest-month').textContent = formatCurrency(highestMonth);
      document.getElementById('lowest-month').textContent = formatCurrency(lowestMonth);

      const ctx = document.getElementById('trendsChart').getContext('2d');
      charts.trends = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthlySpending.labels,
          datasets: [{
            label: 'Monthly Spending',
            data: monthlySpending.amounts,
            borderColor: '#005a9c',
            backgroundColor: 'rgba(0, 90, 156, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#005a9c',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#2c3e50',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#34495e',
              borderWidth: 1,
              callbacks: {
                label: function(context) {
                  return `Spending: ${formatCurrency(context.raw)}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: '#e5e5e5'
              },
              ticks: {
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            }
          }
        }
      });
    }

   function getMonthlyIncomeExpense() {
  const { startDate, endDate } = getDateRange();
  const monthlyData = { labels: [], income: [], expenses: [] };

  let current = new Date(startDate);
  while (current <= endDate) {
    const monthLabel = current.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
    monthlyData.labels.push(monthLabel);

    const monthTransactions = getFilteredTransactions().filter(t => {
      const d = new Date(t.date);
      return d.getFullYear() === current.getFullYear() && d.getMonth() === current.getMonth();
    });

    const monthIncome = monthTransactions.filter(t => t.type === 'income')
                                        .reduce((sum, t) => sum + t.amount, 0);
    const monthExpenses = monthTransactions.filter(t => t.type === 'expense')
                                        .reduce((sum, t) => sum + t.amount, 0);

    monthlyData.income.push(monthIncome);
    monthlyData.expenses.push(monthExpenses);

    current.setMonth(current.getMonth() + 1);
  }

  return monthlyData;
}

  function getMonthlySpending() {
  const { startDate, endDate } = getDateRange();
  const monthlyData = {
    labels: [],
    amounts: []
  };

  const current = new Date(startDate);

  while (current <= endDate) {
    const monthLabel = current.toLocaleDateString('en-US', { 
      month: 'short', 
      year: '2-digit' 
    });
    monthlyData.labels.push(monthLabel);

    // Gather all transactions from months
    let monthTransactions = [];
    Object.values(budgetData.months || {}).forEach(monthData => {
      if (monthData.transactions) {
        monthTransactions = monthTransactions.concat(monthData.transactions.filter(t => {
          const tDate = new Date(t.date);
          return tDate.getFullYear() === current.getFullYear() &&
                 tDate.getMonth() === current.getMonth() &&
                 t.type === 'expense';
        }));
      }
    });

    const monthSpending = monthTransactions.reduce((sum, t) => sum + t.amount, 0);
    monthlyData.amounts.push(monthSpending);

    current.setMonth(current.getMonth() + 1);
  }

  return monthlyData;
}



    function applyFilters() {
      if (currentDateRange === 'custom') {
        const fromDate = document.getElementById('fromDate').value;
        const toDate = document.getElementById('toDate').value;
        
        if (!fromDate || !toDate) {
          alert('Please select both start and end dates for custom range.');
          return;
        }
        
        if (new Date(fromDate) > new Date(toDate)) {
          alert('Start date must be before end date.');
          return;
        }
      }

      loadAllReports();
    }

  function formatCurrency(amount, isOutflow = false) {
  if (isNaN(amount)) return "";
  
  const currencySymbols = {
    "USD": "$",
    "PHP": "₱",
    "EUR": "€",
    "JPY": "¥"
  };
  
  const symbol = currencySymbols[userCurrency] || "$";
  
  const formatter = new Intl.NumberFormat("en", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
  
  const formattedAmount = formatter.format(Math.abs(amount));
  
  if (isOutflow) {
    return `-${symbol}${formattedAmount}`;
  }
  
  return `${symbol}${formattedAmount}`;
}

    function exportData() {
      const transactions = getFilteredTransactions();
      const { startDate, endDate } = getDateRange();
      
      const csvContent = [
        ['Date', 'Type', 'Category', 'Amount', 'Description'],
        ...transactions.map(t => [
          t.date,
          t.type,
          t.category || 'Uncategorized',
          t.amount,
          t.description || ''
        ])
      ].map(row => row.join(',')).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ynab-report-${startDate.toISOString().slice(0, 10)}-${endDate.toISOString().slice(0, 10)}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }

// ===== GOALS Section =====
// Authentication state listener
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = "auth.html";
                return;
            }
            
            currentUser = user;
            try {
                const userDoc = await db.collection("users").doc(user.uid).get();
                const userData = userDoc.data();
                
                if (userDoc.exists && userData?.approved === true) {
                    await loadGoals();
                } else {
                    alert("Your account is not yet approved.");
                    await auth.signOut();
                }
            } catch (err) {
                console.error("Error fetching user:", err);
            }
        });

// Load goals from Firebase with transactions merged
async function loadGoals() {
    if (!currentUser) return;

    try {
        // Load all goals
        const goalsRef = db.collection("budget").doc(currentUser.uid).collection("goals");
        const goalsSnap = await goalsRef.orderBy("createdAt", "desc").get();
        
        // Load all goal transactions
        const txRef = db.collection("budget").doc(currentUser.uid).collection("goalTransactions");
        const txSnap = await txRef.get();

        // Group transactions by goalId
        const txMap = {};
        txSnap.forEach(doc => {
            const tx = doc.data();
            if (!txMap[tx.goalId]) txMap[tx.goalId] = 0;
            if (tx.type === "contribution") {
                txMap[tx.goalId] += tx.amount;
            } else if (tx.type === "withdrawal") {
                txMap[tx.goalId] -= tx.amount;
            }
        });

        // Build goal list
        goals = [];
        goalsSnap.forEach(doc => {
            const goalData = doc.data();
            const goalId = doc.id;
            const currentAmount = txMap[goalId] || 0;

            goals.push({
                id: goalId,
                ...goalData,
                currentAmount // override if missing
            });
        });

        renderGoals();
    } catch (error) {
        console.error("Error loading goals:", error);
        showToast("Error loading goals", "error");
    }
}


        // Render goals
       // Render goals
function renderGoals() {
    const goalsGrid = document.getElementById("goals-grid");
    const emptyState = document.getElementById("empty-state");

    if (goals.length === 0) {
        goalsGrid.style.display = "none";
        emptyState.style.display = "block";
        return;
    }

    goalsGrid.style.display = "grid";
    emptyState.style.display = "none";
    
    console.log("🎯 Rendering goals with currency:", userCurrency); // Add this debug line
    
    goalsGrid.innerHTML = goals.map(goal => createGoalCard(goal)).join("");
}
        // Create goal card HTML
function createGoalCard(goal) {
    const progress = Math.min((goal.currentAmount / goal.targetAmount) * 100, 100);
    const isCompleted = goal.currentAmount >= goal.targetAmount;
    const daysRemaining = goal.targetDate ? Math.ceil((new Date(goal.targetDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
    
    let statusClass = "status-active";
    let statusText = "Active";
    
    if (isCompleted) {
        statusClass = "status-completed";
        statusText = "Completed";
    } else if (goal.status === "paused") {
        statusClass = "status-paused";
        statusText = "Paused";
    }
    
    return `
        <div class="goal-card">
            <div class="goal-header">
                <div>
                    <div class="goal-title">${goal.name}</div>
                    <div class="goal-type">${goal.type}</div>
                </div>
                <div class="goal-actions">
                    <button class="action-btn" onclick="editGoal('${goal.id}')" title="Edit">
                        ✏️
                    </button>
                    <button class="action-btn" onclick="deleteGoal('${goal.id}')" title="Delete">
                        🗑️
                    </button>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                    <div class="progress-label" style="left: ${progress}%;">${progress.toFixed(1)}%</div>
                </div>
                <div class="progress-text">
                    <span>${progress.toFixed(1)}% complete</span>
                    <span class="goal-status ${statusClass}">${statusText}</span>
                </div>
            </div>

            <div class="goal-amounts">
                <div class="amount-item">
                    <div class="amount-label">Current</div>
                    <div class="amount-value">${formatCurrency(goal.currentAmount)}</div>
                </div>
                <div class="amount-item">
                    <div class="amount-label">Target</div>
                    <div class="amount-value">${formatCurrency(goal.targetAmount)}</div>
                </div>
            </div>

            <div class="goal-details">
                ${goal.description ? `<p>${goal.description}</p>` : ""}
                ${goal.targetDate ? `<p><strong>Target:</strong> ${formatDate(goal.targetDate)}</p>` : ""}
                ${daysRemaining !== null ? `<p><strong>Days remaining:</strong> ${daysRemaining > 0 ? daysRemaining : 'Past due'}</p>` : ""}
                ${goal.monthlyContribution ? `<p><strong>Monthly:</strong> ${formatCurrency(goal.monthlyContribution)}</p>` : ""}
            </div>

            ${!isCompleted ? `
                <div class="add-funds-section">
                    <input type="number" class="funds-input" id="funds-${goal.id}" placeholder="Add amount" min="0" step="0.01">
                    <button class="add-funds-btn" onclick="addFunds('${goal.id}')">Add Funds</button>
                </div>
            ` : ""}
        </div>
    `;
}
        // Add funds to goal
        async function addFunds(goalId) {
            const input = document.getElementById(`funds-${goalId}`);
            const amount = parseFloat(input.value);

            if (isNaN(amount) || amount <= 0) {
                showToast("Please enter a valid amount", "error");
                return;
            }

            try {
                const goalRef = db.collection("budget").doc(currentUser.uid).collection("goals").doc(goalId);
                const goalDoc = await goalRef.get();
                
                if (!goalDoc.exists) {
                    showToast("Goal not found", "error");
                    return;
                }

                const goalData = goalDoc.data();
                const newAmount = goalData.currentAmount + amount;

                await goalRef.update({
                    currentAmount: newAmount,
                    lastContribution: {
                        amount: amount,
                        date: new Date().toISOString()
                    },
                    updatedAt: new Date().toISOString()
                });

                // Add transaction record
                await addGoalTransaction(goalId, amount, 'contribution');

                input.value = "";
                await loadGoals();
                
                const goal = goals.find(g => g.id === goalId);
                if (newAmount >= goal.targetAmount) {
                    showToast(`Congratulations! You've reached your "${goal.name}" goal!`, "success");
                } else {
                    showToast("Funds added successfully!", "success");
                }
            } catch (error) {
                console.error("Error adding funds:", error);
                showToast("Error adding funds", "error");
            }
        }

        // Add goal transaction
        async function addGoalTransaction(goalId, amount, type) {
            try {
                const transactionRef = db.collection("budget").doc(currentUser.uid).collection("goalTransactions");
                await transactionRef.add({
                    goalId: goalId,
                    amount: amount,
                    type: type, // 'contribution' or 'withdrawal'
                    date: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                });
            } catch (error) {
                console.error("Error adding goal transaction:", error);
            }
        }

        // Open add goal modal
        function openAddGoalModal() {
            editingGoalId = null;
            document.getElementById("modal-title").textContent = "Add New Goal";
            document.getElementById("goal-form").reset();
            document.getElementById("goal-modal").classList.remove("hidden");
        }

        // Close goal modal
        function closeGoalModal() {
            document.getElementById("goal-modal").classList.add("hidden");
        }

        // Edit goal
        async function editGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            editingGoalId = goalId;
            document.getElementById("modal-title").textContent = "Edit Goal";
            
            document.getElementById("goal-name").value = goal.name;
            document.getElementById("goal-type").value = goal.type;
            document.getElementById("target-amount").value = goal.targetAmount;
            document.getElementById("target-date").value = goal.targetDate || "";
            document.getElementById("monthly-contribution").value = goal.monthlyContribution || "";
            document.getElementById("goal-description").value = goal.description || "";
            
            document.getElementById("goal-modal").classList.remove("hidden");
        }

        // Delete goal
        async function deleteGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            if (!goal) return;

            if (!confirm(`Are you sure you want to delete "${goal.name}"? This action cannot be undone.`)) {
                return;
            }

            try {
                await db.collection("budget").doc(currentUser.uid).collection("goals").doc(goalId).delete();
                
                // Delete related transactions
                const transactionsRef = db.collection("budget").doc(currentUser.uid).collection("goalTransactions");
                const transactionsSnapshot = await transactionsRef.where("goalId", "==", goalId).get();
                
                const batch = db.batch();
                transactionsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                await loadGoals();
                showToast("Goal deleted successfully", "success");
            } catch (error) {
                console.error("Error deleting goal:", error);
                showToast("Error deleting goal", "error");
            }
        }

        // Handle goal form submission
        document.getElementById("goal-form").addEventListener("submit", async (e) => {
            e.preventDefault();

            const name = document.getElementById("goal-name").value.trim();
            const type = document.getElementById("goal-type").value;
            const targetAmount = parseFloat(document.getElementById("target-amount").value);
            const targetDate = document.getElementById("target-date").value || null;
            const monthlyContribution = parseFloat(document.getElementById("monthly-contribution").value) || null;
            const description = document.getElementById("goal-description").value.trim() || null;

            if (!name || !type || isNaN(targetAmount) || targetAmount <= 0) {
                showToast("Please fill in all required fields", "error");
                return;
            }

            const goalData = {
                name,
                type,
                targetAmount,
                targetDate,
                monthlyContribution,
                description,
                currentAmount: 0,
                status: "active",
                updatedAt: new Date().toISOString()
            };

            try {
                if (editingGoalId) {
                    // Update existing goal
                    await db.collection("budget").doc(currentUser.uid).collection("goals").doc(editingGoalId).update(goalData);
                    showToast("Goal updated successfully", "success");
                } else {
                    // Create new goal
                    goalData.createdAt = new Date().toISOString();
                    await db.collection("budget").doc(currentUser.uid).collection("goals").add(goalData);
                    showToast("Goal created successfully", "success");
                }

                closeGoalModal();
                await loadGoals();
            } catch (error) {
                console.error("Error saving goal:", error);
                showToast("Error saving goal", "error");
            }
        });

        // Utility functions
        function formatNumber(num) {
            return new Intl.NumberFormat('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showToast(message, type = "success") {
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add("show"), 100);
            
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modal when clicking outside
        document.addEventListener("click", (e) => {
            if (e.target.classList.contains("modal")) {
                closeGoalModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                closeGoalModal();
            }
        });

// ===== Settings Section =====

 // Theme Management System
    class ThemeManager {
      constructor() {
        this.currentTheme = 'classic';
        this.themeToggle = document.getElementById('themeToggle');
        this.themeDropdown = document.getElementById('themeDropdown');
        this.currentThemeName = document.getElementById('currentThemeName');
        this.themeDisplay = document.getElementById('themeDisplay');
        
        this.init();
      }

      init() {
        // Load saved theme
        const savedTheme = localStorage.getItem('budgetmaster-theme') || 'classic';
        this.setTheme(savedTheme);

        // Event listeners
        this.themeToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleDropdown();
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!this.themeToggle.contains(e.target) && !this.themeDropdown.contains(e.target)) {
            this.closeDropdown();
          }
        });

        // Theme option clicks
        this.themeDropdown.querySelectorAll('.theme-option').forEach(option => {
          option.addEventListener('click', (e) => {
            const theme = e.currentTarget.dataset.theme;
            this.setTheme(theme);
            this.closeDropdown();
          });
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            this.closeDropdown();
          }
        });
      }

      toggleDropdown() {
        this.themeDropdown.classList.toggle('open');
      }

      closeDropdown() {
        this.themeDropdown.classList.remove('open');
      }

      setTheme(theme) {
        // Remove current theme
        document.documentElement.removeAttribute('data-theme');
        
        // Set new theme
        if (theme !== 'classic') {
          document.documentElement.setAttribute('data-theme', theme);
        }
        
        this.currentTheme = theme;
        
        // Update UI
        this.updateThemeDisplay();
        this.updateActiveOption();
        
        // Save theme preference
        localStorage.setItem('budgetmaster-theme', theme);
        
        // Emit theme change event for other parts of the app
        window.dispatchEvent(new CustomEvent('themeChanged', { detail: { theme } }));
      }

      updateThemeDisplay() {
        const themeNames = {
          'classic': 'Classic',
          'dark': 'Dark',
          'koopa-beach': 'Koopa Beach',
          'choco-mountain': 'Choco Mountain',
          'moo-moo-farm': 'Moo Moo Farm',
          'bowsers-castle': 'Bowser\'s Castle',
          'yoshi-valley': 'Yoshi Valley',
          'rainbow-road': 'Rainbow Road',
          'lobster-life': 'Lobster Life',
          'hacker-news': 'Hacker News'
        };

        const displayName = themeNames[this.currentTheme];
        this.currentThemeName.textContent = displayName;
        this.themeDisplay.textContent = displayName;
      }

      updateActiveOption() {
        this.themeDropdown.querySelectorAll('.theme-option').forEach(option => {
          option.classList.remove('active');
          if (option.dataset.theme === this.currentTheme) {
            option.classList.add('active');
          }
        });
      }

      getCurrentTheme() {
        return this.currentTheme;
      }

      // Method to get theme colors for charts/dynamic content
      getThemeColors() {
        const computedStyle = getComputedStyle(document.documentElement);
        return {
          primary: computedStyle.getPropertyValue('--primary').trim(),
          secondary: computedStyle.getPropertyValue('--secondary').trim(),
          text: computedStyle.getPropertyValue('--text').trim(),
          textLight: computedStyle.getPropertyValue('--text-light').trim(),
          green: computedStyle.getPropertyValue('--ynab-green').trim(),
          red: computedStyle.getPropertyValue('--ynab-red').trim(),
          orange: computedStyle.getPropertyValue('--ynab-orange').trim(),
          bg: computedStyle.getPropertyValue('--bg').trim(),
          cardBg: computedStyle.getPropertyValue('--card-bg').trim(),
        };
      }
    }

    // Initialize theme manager
    const themeManager = new ThemeManager();

    // Make theme manager globally available
    window.ThemeManager = themeManager;

    // Example of listening to theme changes (for updating charts, etc.)
    window.addEventListener('themeChanged', (e) => {
      console.log('Theme changed to:', e.detail.theme);
      // Here you could update charts, reload components, etc.
    });

    // Demo: Log theme colors when theme changes
    window.addEventListener('themeChanged', () => {
      setTimeout(() => {
        console.log('Current theme colors:', themeManager.getThemeColors());
      }, 100); // Small delay to ensure CSS has updated
    });

// ===== Load user settings on login =====
// Update the existing Firebase auth listener to load rollover settings
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    currentUser = user;

    firebase.firestore().collection("users").doc(user.uid).get().then((doc) => {
      if (doc.exists) {
        const data = doc.data();
        document.getElementById("displayName").value = data.displayName || user.displayName || "";
        document.getElementById("email").value = user.email || "";
        
        // ✅ Set currency in dropdown AND global variable
        const savedCurrency = data.currency || "USD";
        document.getElementById("currency").value = savedCurrency;
        userCurrency = savedCurrency;
        
        console.log("✅ Settings loaded. Currency:", userCurrency);
        
        // Load rollover settings
        if (data.rolloverSettings) {
          const settings = data.rolloverSettings;
          document.getElementById("rolloverMode").value = settings.mode || "manual";
          if (settings.automaticDay) {
            document.getElementById("automaticRolloverDay").value = settings.automaticDay;
          }
          lastRolloverDate = settings.lastRollover || null;
          toggleRolloverSettings();
          
          // Setup automatic rollover if needed
          if (settings.mode === "automatic" && settings.automaticDay) {
            setupAutomaticRollover(settings.automaticDay);
          }
        }
      }
    });
  } else {
    currentUser = null;
  }
});


// Updated Save Settings button to exclude startDay
document.getElementById("saveBtn").addEventListener("click", async () => {
  const displayName = document.getElementById("displayName").value.trim();
  const currency = document.getElementById("currency").value;

  try {
    // Save to Firestore
    await firebase.firestore().collection("users").doc(currentUser.uid).set({
      displayName, 
      currency
    }, { merge: true });

    // Update Firebase Auth profile name
    await currentUser.updateProfile({ displayName });

    // ✅ Update global currency variable immediately
    userCurrency = currency;
    
    console.log("💰 Currency updated to:", userCurrency);
    
    // ✅ Reload all data with new currency format
    await loadBudget();
    await loadAccounts();
    await loadBudgetSection();
    await loadGoals(); // This reloads goals with new currency
    
    // ✅ Force re-render of goals UI
    renderGoals();
    
    // ✅ Re-render budget data
    const docRef = db.collection("budget").doc(currentUser.uid);
    const docSnap = await docRef.get();
    const data = docSnap.data();
    if (data) {
      const currentMonth = data.currentMonth || new Date().toISOString().slice(0, 7);
      const monthDocRef = docRef.collection("months").doc(currentMonth);
      const monthSnap = await monthDocRef.get();
      if (monthSnap.exists) {
        renderBudget(monthSnap.data());
      }
    }
    
    alert("✅ Settings saved! Currency updated to " + currency);
  } catch (error) {
    console.error("Error saving settings:", error);
    alert("❌ Failed to save settings. Please try again.");
  }
});

 logoutLink.addEventListener('click', (e) => {
    e.preventDefault(); // prevent jumping to #logout
    firebase.auth().signOut()
      .then(() => {
        window.location.href = "auth.html"; // redirect after logout
      })
      .catch((error) => {
        console.error("Logout error:", error);
      });
  });

document.querySelectorAll('.settings-sidebar li').forEach(item => {
  item.addEventListener('click', () => {
    document.querySelectorAll('.settings-sidebar li').forEach(i => i.classList.remove('active'));
    item.classList.add('active');

    const sectionToShow = item.getAttribute('data-section');
    document.querySelectorAll('.settings-section').forEach(sec => {
      sec.style.display = sec.id === sectionToShow ? 'block' : 'none';
    });
  });
});







// ===== Reauthenticate User Modal =====
function reauthenticateUserModal() {
  return new Promise((resolve) => {
    const modal = document.getElementById("reauthModal");
    const passwordInput = document.getElementById("reauthPassword");
    const confirmBtn = document.getElementById("reauthConfirm");
    const cancelBtn = document.getElementById("reauthCancel");

    passwordInput.value = "";
    passwordInput.type = "password"; // Mask the password input
    modal.style.display = "flex";

    confirmBtn.onclick = async () => {
      const password = passwordInput.value.trim();
      if (!password) return alert("Please enter your password.");

      const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
      try {
        await currentUser.reauthenticateWithCredential(credential);
        modal.style.display = "none";
        resolve(true);
      } catch (err) {
        alert("❌ Incorrect password. Try again.");
      }
    };

    cancelBtn.onclick = () => {
      modal.style.display = "none";
      resolve(false);
    };
  });
}

// ===== Export Backup =====
document.getElementById("exportBtn").addEventListener("click", async () => {
  const ok = await reauthenticateUserModal();
  if (!ok) return;

  const monthsSnap = await firebase.firestore().collection("budget").doc(currentUser.uid).collection("months").get();
  const goalsSnap = await firebase.firestore().collection("budget").doc(currentUser.uid).collection("goals").get();

  const exportObj = {
    months: monthsSnap.docs.map(d => ({ id: d.id, ...d.data() })),
    goals: goalsSnap.docs.map(d => ({ id: d.id, ...d.data() }))
  };

  const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "budget_backup.json";
  a.click();
  URL.revokeObjectURL(url);
});

// ===== Clear Data =====
document.getElementById("clearDataBtn").addEventListener("click", async () => {
  const ok = await reauthenticateUserModal();
  if (!ok) return;

  if (!confirm("Clear all your budget data?")) return;

  const monthsSnap = await firebase.firestore().collection("budget").doc(currentUser.uid).collection("months").get();
  for (const d of monthsSnap.docs) await d.ref.delete();

  const goalsSnap = await firebase.firestore().collection("budget").doc(currentUser.uid).collection("goals").get();
  for (const d of goalsSnap.docs) await d.ref.delete();

  alert("🗑️ Data cleared.");
});

// ===== Delete Account =====
document.getElementById("deleteAccountBtn").addEventListener("click", async () => {
  const ok = await reauthenticateUserModal();
  if (!ok) return;

  if (!confirm("Delete account permanently? This cannot be undone.")) return;

  await firebase.firestore().collection("users").doc(currentUser.uid).delete();

  const monthsSnap = await firebase.firestore().collection("budget").doc(currentUser.uid).collection("months").get();
  for (const d of monthsSnap.docs) await d.ref.delete();

  const goalsSnap = await firebase.firestore().collection("budget").doc(currentUser.uid).collection("goals").get();
  for (const d of goalsSnap.docs) await d.ref.delete();

  await currentUser.delete();

  alert("🚫 Account deleted.");
  window.location.href = "sign_auth.html";
});






  function openModal(id) { document.getElementById(id).classList.remove("hidden"); }
  function closeModal(id) { document.getElementById(id).classList.add("hidden"); }
  async function logout() { if (currentUser) await auth.signOut(); }

</script>


</body>
</html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            